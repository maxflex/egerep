<?php

namespace App\Console\Commands;

use App\Models\Sms;
use Illuminate\Console\Command;
use Illuminate\Support\Facades\DB;

class SendSMSToOldClients extends Command
{
    /**
     * The name and signature of the console command.
     *
     * @var string
     */
    protected $signature = 'once:sendSmsToOldClients';

    /**
     * The console command description.
     *
     * @var string
     */
    protected $description = 'Command description';

    /**
     * Create a new command instance.
     *
     * @return void
     */
    public function __construct()
    {
        parent::__construct();
    }

    /**
     * Execute the console command.
     *
     * @return mixed
     */
    public function handle()
    {
        $this->line('Starting ...');

        $all_numbers = [
            '79262645886',	'79037805451',	'79168086738',	'79636058802',	'79162005025',	'79175913561',	'79168194853',	'79166778809',	'79652898355',	'79165683592',	'79255071662',	'79104715026',	'79060533333',	'79104543758',	'79163975127',	'79166088160',	'79636802504',	'79160501070',	'79153306255',	'79263858784',	'79096505808',	'79250390764',	'79032789694',	'79857278700',	'79266075888',	'79067440027',	'79104442206',	'79166706099',	'79060611549',	'79151541746',	'79060423828',	'79191018984',	'79165433271',	'79254280417',	'79857457002',	'79250056098',	'79260274905',
        ];

        $egecentr_clients = [
            '55',	'86',	'87',	'104',	'118',	'159',	'191',	'237',	'382',	'393',	'420',	'427',	'606',	'666',	'715',	'759',	'801',	'843',	'856',	'878',	'919',	'964',	'1087',	'1149',	'1191',	'1219',	'1225',	'1228',	'1234',	'1236',	'1249',	'1272',	'1283',	'1312',	'1317',	'1347',	'1365',	'1377',	'1384',	'1402',	'1412',	'1413',	'1420',	'1437',	'1480',	'1494',	'1521',	'1532',	'1533',	'1544',	'1598',	'1613',	'1617',	'1676',	'1749',	'1754',	'1771',	'1783',	'1803',	'1882',	'1951',	'1957',	'1966',	'1968',	'1995',	'2014',	'2023',	'2045',	'2088',	'2099',	'2101',	'2141',	'2170',	'2198',	'2268',	'2286',	'2329',	'2351',	'2361',	'2368',	'2371',	'2402',	'2426',	'2450',	'2466',	'2484',	'2498',	'2518',	'2541',	'2576',	'2611',	'2629',	'2632',	'2635',	'2642',	'2664',	'2666',	'2673',	'2686',	'2705',	'2713',	'2750',	'2751',	'2756',	'2775',	'2826',	'2866',	'2901',	'2932',	'2933',	'2958',	'2974',	'2976',	'3019',	'3045',	'3100',	'3109',	'3113',	'3114',	'3116',	'3129',	'3130',	'3135',	'3141',	'3143',	'3146',	'3148',	'3161',	'3166',	'3173',	'3185',	'3202',	'3206',	'3248',	'3289',	'3290',	'3299',	'3302',	'3308',	'3336',	'3337',	'3339',	'3351',	'3353',	'3354',	'3360',	'3372',	'3381',	'3382',	'3388',	'3391',	'3392',	'3394',	'3412',	'3420',	'3423',	'3429',	'3431',	'3435',	'3438',	'3447',	'3466',	'3473',	'3478',	'3488',	'3501',	'3505',	'3509',	'3511',	'3515',	'3524',	'3529',	'3540',	'3541',	'3543',	'3545',	'3558',	'3564',	'3565',	'3566',	'3575',	'3576',	'3589',	'3590',	'3592',	'3594',	'3599',	'3610',	'3617',	'3628',	'3667',	'3680',	'3691',	'3755',	'3759',	'3828',	'3829',	'3834',	'3892',	'3900',	'3910',	'3927',	'3928',	'3948',	'3990',	'3993',	'4014',	'4020',	'4061',	'4109',	'4118',	'4135',	'4164',	'4208',	'4210',	'4227',	'4237',	'4247',	'4262',	'4265',	'4272',	'4279',	'4306',	'4337',	'4338',	'4382',	'4418',	'4420',	'4455',	'4456',	'4458',	'4492',	'4512',	'4521',	'4522',	'4524',	'4531',	'4532',	'4534',	'4536',	'4562',	'4580',	'4587',	'4620',	'4627',	'4630',	'4631',	'4656',	'4660',	'4706',	'4737',	'4775',	'4777',	'4790'
        ];
        $egecentr_client_phones = \DB::connection("egecrm")
                                    ->table("requests")
                                    ->select(['phone', 'phone2', 'phone3'])
                                    ->whereRaw("(phone <> '' or phone2 <> '' or phone3 <> '')")
                                    ->whereIn('id', $egecentr_clients)
                                    ->get();

        foreach ($egecentr_client_phones as $client_phones) {
            $all_numbers[] = $client_phones->phone;
            $all_numbers[] = $client_phones->phone2;
            $all_numbers[] = $client_phones->phone3;
        }

        $egecentr_denied_clients = \DB::connection("egecrm")
                                    ->table("requests")
                                    ->select(["phone", "phone2", "phone3"])
                                    ->whereRaw("(phone <> '' or phone2 <> '' or phone3 <> '')")
                                    ->where("id_status", 5)
                                    ->whereRaw("date > '2016-06-01'")
                                    ->get();

        foreach ($egecentr_denied_clients as $client_phones) {
            $all_numbers[] = $client_phones->phone;
            $all_numbers[] = $client_phones->phone2;
            $all_numbers[] = $client_phones->phone3;
        }


        $egerep_clients = [
            '9213','6388','8712','6867','6826','8922','11129','5533','6045','11843','12177','8628','9858','5353','10336','8341','10660','7281','10018','9305','9047','8456','5157','11703','10163','7182','10028','11633','5505','5665','8285','7973','9037','10796','4975','4615','10927','7712','6387','6844','7296','12226','8731','11071','8978','7618','7081','10387','11408','8063','10357','11201','11954','9416','8193','9492','7176','8439','10563','10539','11483','12826','11679','5097','7301','11609','9500','9016','12032','9341','11600','7694','8881','9954','10468','6978','10412','9778','9818','10860','12463','10693','11005','12729','11783','9437','5356','7869','7038','12104','9243','8249','11449','11004','7381','6956','11575','12493','7197','12495','12841','6146','12818','6985','10795','12343','11891','6686','6113','12771','9919','10486','10809','5675','12223','10690','8691','11825','9900','7234','1333','7681','10182','6799','12191','11454','9445','11317','7834','12811','10331','8259','8715','7233','11873','10722','10208','12631','7391','11966','10628','11906','8394','8685','6735','9870','11854','12100','11245','8460','8556','12512','9667','12554','12497','11431','6302','10925','7118','7452','8154','9617','9722','10946','655','4922','4460','11415','9436','11465','7965','7529','9345','9211','12574','9908','8303','11395','9442','11134','7859','7445','8077','7816','8342','6063','9849','7370','8874','11956','7294','8859','9396','10307','10533','11635','11779','7462','9404','8957','6289','9086','10071','12066','10137','7424','8703','9137','10459','8268','11845','7303','10804','3286','9295','12133','11274','9444','8355','11229','11484','5564','8669','10778','12134','11366','11473','12095','8260','7129','11520','8407','9160','10474','7822','5516','7369','11239','9163','9447','8911','10767','7676','9368','12218','8609','12222','11228','6370','11039','258','11519','2858','6998','12478','12431','8366','8451','10789','12021','8035','12232','8282','6549','5576','6643','8593','6761','8759','10857','11380','9105','8906','12393','8437','9379','8517','10782','8149','7327','12593','10259','12801','5227','5727','8595','6122','10013','7325','8939','11957','8504','9448','7585','12280','10470','7723','8061','6778','9714','10666','11294','12081','9749','11842','11499','9173','12012','10885','9014','8762','8749','9891','8632','11403','9578','12578','12536','10025','11752','7892','6979','8898','6977','7202','10483','12752','11663','8645','7204','12202','10645','12136','8784','5302','9303','9283','11080','11336','4683','7718','7988','12501','7797','8547','11353','9608','8469','6616','12466','6865','7894','11673','5724','9612','7921','9816','8752','12332','10670','8688','8166','6908','8101','10615','7487','10820','1496','7169','6772','11272','8203','8383','5908','6716','10171','12698','9023','8235','11254','9952','9309','11990','8359','12500','7161','10884','6501','2116','6775','6973','12524','10528','11199','9583','9928','11852','8984','7070','7564','10282','11563','10241','10672','10084','7829','10460','11767','7911','11528','9983','5286','9821','11233','11646','8783','7845','7515','5387','12726','11284','8668','8130','10270','8634','11844','12601','7776','11439','9949','12228','9158','10826','11978','5821','5808','10281','8168','11419','9084','4971','9258','8423','5592','9905','6637','9555','12537','11616','11692','9365','7612','12364','7832','7714','8533','7805','8679','6584','10834','12283','5200','12245','9360','654'
        ];
        $egerep_client_phones = \DB::table("clients")
                                ->select(['phone', 'phone2', 'phone3', 'phone4'])
                                ->whereRaw("(phone <> '' or phone2 <> '' or phone3 <> '' or phone4 <> '')")
                                ->whereIn('id', $egerep_clients)
                                ->get();

        foreach ($egerep_client_phones as $client_phones) {
            $all_numbers[] = $client_phones->phone;
            $all_numbers[] = $client_phones->phone2;
            $all_numbers[] = $client_phones->phone3;
            $all_numbers[] = $client_phones->phone4;
        }

        $this->line('Total '.count($all_numbers));
        $this->line('Uniqing ...');
        $all_numbers = array_filter(array_unique($all_numbers), function($phone) { return strpos($phone, '79') === 0;});
        $this->line('Uniqued. Total '.count($all_numbers));

        $this->line('Sending ...');
        Sms::sendToNumbers(array_slice($all_numbers, 0, 5), 'ЕГЭ-Центр информирует: запись на курсы ЕГЭ/ОГЭ заканчивается 27 августа. Тел. +7(495)646-85-92, м.Тургеневская', 1);
//        Sms::sendToNumbers(array_slice($all_numbers, 5), 'ЕГЭ-Центр информирует: запись на курсы ЕГЭ/ОГЭ заканчивается 27 августа. Тел. +7(495)646-85-92, м.Тургеневская', 1);
    }
}
