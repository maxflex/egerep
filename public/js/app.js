(function(){var t=[].indexOf||function(t){for(var e=0,n=this.length;e<n;e++)if(e in this&&this[e]===t)return e;return-1};angular.module("Egerep",["ngSanitize","ngResource","ngMaterial","ngMap","ngAnimate","ui.sortable","ui.bootstrap","angular-ladda","svgmap"]).config(["$compileProvider",function(t){return t.aHrefSanitizationWhitelist(/^\s*(https?|ftp|mailto|chrome-extension|sip|tel):/)}]).config(function(t){return t.formatDate=function(t){return moment(t).format("DD MMMM YYYY")}}).directive("convertToNumber",function(){return{require:"ngModel",link:function(t,e,n,r){return r.$parsers.push(function(t){return parseInt(t,10)}),r.$formatters.push(function(t){return""+t})}}}).directive("convertToNumberNew",function(){return{require:"ngModel",link:function(t,e,n,r){return r.$parsers.push(function(t){return parseInt(t,10)}),r.$formatters.push(function(t){return t||0===t?""+t:""})}}}).filter("cut",function(){return function(t,e,n,r,o){var a;return null==r&&(r=""),null==o&&(o="…"),t&&""!==t?(n=parseInt(n,10))?t.length<=n?t:(t=t.substr(0,n),e&&(a=t.lastIndexOf(" "),a!==-1&&("."!==t.charAt(a-1)&&","!==t.charAt(a-1)||(a-=1),t=t.substr(0,a))),t+o):t:r}}).filter("hideZero",function(){return function(t){return t>0?t:null}}).filter("formatDateTime",function(){return function(t){return moment(t).format("DD.MM.YY в HH:mm")}}).run(function(e,n,r){return r.bind("IncomingRequest",function(t){var e,n,r;return n=$("#request-count"),r=$("#request-counter"),e=7e3,r.removeClass("text-success").removeClass("text-danger").css("opacity",1),t["delete"]?(n.text(parseInt(n.text())-1),n.animate({"background-color":"#158E51"},e/2).animate({"background-color":"#777"},e/2),r.text("-1").addClass("text-success").animate({opacity:0},e)):(n.text(parseInt(n.text())+1),n.animate({"background-color":"#A94442"},e/2).animate({"background-color":"#777"},e/2),r.text("+1").addClass("text-danger").animate({opacity:0},e))}),r.bind("AttachmentCountChanged",function(t){var e,n,r;return n=$("#attachment-count"),r=$("#attachment-counter"),e=7e3,r.removeClass("text-success").removeClass("text-danger").css("opacity",1),t["delete"]?(n.text(parseInt(n.text())-1),n.animate({"background-color":"#A94442"},e/2).animate({"background-color":"#777"},e/2),r.text("-1").addClass("text-danger").animate({opacity:0},e)):(n.text(parseInt(n.text())+1),n.animate({"background-color":"#158E51"},e/2).animate({"background-color":"#777"},e/2),r.text("+1").addClass("text-success").animate({opacity:0},e))}),r.bind("EmergencyExit",function(){return $.get("logout"),window.location.replace("https://google.com/")}),e.dataLoaded=n.defer(),e.frontendStop=function(t){if(null==t&&(t=!0),e.frontend_loading=!1,e.dataLoaded.resolve(!0),t)return rebindMasks()},e.range=function(t,e,n){var r,o;for(n=n||1,o=[],r=t;r<=e;)o.push(r),r+=n;return o},e.toggleEnum=function(n,r,o,a,i,u){var s,c,d;if(null==a&&(a=[]),null==i&&(i=[]),null==u&&(u=!1),u||(s=parseInt(n[r]),!(t.call(a,s)>=0||isNaN(parseInt(n[r]))&&a.indexOf(n[r])!==-1))||i)return d=Object.keys(o),c=d.indexOf(n[r].toString()),c++,c>d.length-1&&(c=0),n[r]=d[c],(isNaN(parseInt(n[r]))&&a.indexOf(n[r])!==-1||t.call(a,c)>=0)&&!i?e.toggleEnum(n,r,o,a,i,!0):void 0},e.toggleEnumServer=function(e,n,r,o,a,i,u){var s,c,d,l,f;if(null==a&&(a=[]),null==i&&(i=[]),null==u&&(u=!1),s=e[n],!(t.call(i,s)>=0&&u)){for(d=Object.keys(r),c=d.indexOf(e[n].toString());;)if(c++,c>d.length-1&&(c=0),f=isNaN(parseInt(e[n]))?d[c]:c,!(t.call(a,f)>=0||t.call(i,f)>=0))break;return l={id:e.id},l[n]=f,o.update(l,function(){return e[n]=f})}},e.formatDateTime=function(t){return moment(t).format("DD.MM.YY в HH:mm")},e.formatDateCustom=function(t,e){return moment(t).format(e)},e.formatDate=function(t,e){return null==e&&(e=!1),t?moment(t).format("DD.MM.YY"+(e?"YY":"")):""},e.shortenYear=function(t){return t?t.replace(/(\d{2}[\-\.]{1}\d{2}[\-\.]{1})\d{2}(\d{2})/,"$1$2"):""},e.formatTimestamp=function(t,e){return null==e&&(e=!1),"string"==typeof t&&(t=+(t+"000")),t?moment(t).format("DD.MM.YY в HH:mm"+(e?"YY":"")):""},e.dialog=function(t){$("#"+t).modal("show")},e.closeDialog=function(t){$("#"+t).modal("hide")},e.ajaxStart=function(){return ajaxStart(),e.saving=!0},e.ajaxEnd=function(){return ajaxEnd(),e.saving=!1},e.findById=function(t,e){return _.findWhere(t,{id:parseInt(e)})},e.total=function(t,e,n){var r;return null==n&&(n=!1),r=0,$.each(t,function(t,o){var a;return a=o[e],n&&(a=a[n]),r+=a}),r},e.deny=function(t,e){return t[e]=+!t[e]},e.formatBytes=function(t){return t<1024?t+" Bytes":t<1048576?(t/1024).toFixed(1)+" KB":t<1073741824?(t/1048576).toFixed(1)+" MB":(t/1073741824).toFixed(1)+" GB"}})}).call(this),function(){var t;t=!1,window.logoutCountdownClose=function(){return clearInterval(t),t=!1,$("#logout-modal").modal("hide")},window.logoutCountdown=function(){var e;return e=60,$("#logout-seconds").html(e),$("#logout-modal").modal("show"),t=setInterval(function(){if(e--,$("#logout-seconds").html(e),e<=1)return clearInterval(t),setTimeout(function(){return location.reload()},1e3)},1e3)},window.continueSession=function(){return $.get("/auth/continue-session"),logoutCountdownClose()},window.listenToSession=function(t,e){var n,r;return r=new Pusher(t,{cluster:"eu"}),n=r.subscribe("session."+e),n.bind("App\\Events\\LogoutSignal",function(t){switch(t.action){case"notify":return logoutCountdown();case"destroy":return redirect("/logout")}})}}.call(this),function(){angular.module("Egerep").factory("Model",function(t){return t("api/models/:id",{},{update:{method:"PUT"}})}).controller("ModelsIndex",function(t,e,n){return t.models=n.query()}).controller("ModelsForm",function(t,e,n,r){return e(function(){if(t.id>0)return t.model=r.get({id:t.id})})})}.call(this),function(){var t=[].indexOf||function(t){for(var e=0,n=this.length;e<n;e++)if(e in this&&this[e]===t)return e;return-1};angular.module("Egerep").controller("AccountsHiddenCtrl",function(t,e,n){return bindArguments(t,arguments)}).controller("AccountsCtrl",function(e,n,r,o,a,i,u,s,c,d,l,f,m,p,g,h,v,y,b,k,w,x,E,C){var S,M,I,L,D,A,Y,T,O;return bindArguments(n,arguments),n.current_scope=n,n.current_period=0,n.all_displayed=!1,n.getStyle=function(t){return{height:$("#meeting-info-"+t.id).height()+4}},n.splitYear=function(t){var e;return e=t.split("."),e[2]=e[2].slice(2,4),e.join(".")},n.paymentModal=function(t,r){if(null==r&&(r={}),!r.confirmed||n.user.rights.indexOf("48")!==-1)return n.modal_account=t,n.modal_payment=r,e.dialog("add-account-payment")},n.editPayment=function(){return n.modal_payment.id?(C.update(n.modal_payment),e.closeDialog("add-account-payment")):(ajaxStart(),n.modal_payment.account_id=n.modal_account.id,C.save(n.modal_payment,function(t){return n.modal_account.all_payments.push(t),ajaxEnd(),e.closeDialog("add-account-payment")}))},n.removePayment=function(t,r){if(!r.confirmed||n.user.rights.indexOf("48")!==-1)return bootbox.confirm("Вы уверены, что хотите удалить платеж?",function(n){return n===!0&&C["delete"]({id:r.id},function(){return t.all_payments=removeById(t.all_payments,r.id)}),e.closeDialog("add-account-payment")})},n.updateArchive=function(t,r){var o,a,i,u,s;for(i=["id","state","checked"],o={},u=0,s=i.length;u<s;u++)a=i[u],o[a]=n.popup_attachment.archive[a];return e.toggleEnum(o,t,r),n.Archive.update(o,function(t){return _.extendOwn(n.popup_attachment.archive,o)})},angular.element(document).ready(function(){return n.loadPage()}),n.getIndex=function(t,e){var r;return 0===t?e:(r=0,$.each(n.tutor.last_accounts,function(e,o){if(!(e>=t))return r+=n.getDates(e).length}),r+e)},n.loadPage=function(t){return e.frontend_loading=!0,r.get("api/accounts/"+n.tutor_id+(n.current_period?"?date_limit="+n.date_limit:"")).success(function(t){return Y(t),n.current_period++})},Y=function(t){return null===t.account?(n.date_limit=n.first_attachment_date,n.all_displayed=!0):n.current_period?(n.tutor.last_accounts.unshift(t.account),n.date_limit=moment(t.account.date_end).subtract(7,"days").format("YYYY-MM-DD"),n.left=t.left,t.accounts_in_week.length&&(n.tutor.last_accounts=t.accounts_in_week.concat(n.tutor.last_accounts))):(n.tutor=t,n.tutor.planned_account&&n.tutor.planned_account.id&&(n.tutor.planned_account.user_id+="",n.tutor.planned_account.payment_method+="")),e.frontend_loading=!1,$(".accounts-table").stickyTableHeaders("destroy"),o(function(){return $(".accounts-table").stickyTableHeaders(),$(".right-table-scroll").scroll(function(){return $(window).trigger("resize.stickyTableHeaders")})})},M=function(t){return t>0?moment(n.tutor.last_accounts[t-1].date_end).add(1,"days").toDate():new Date(n.date_limit)},S=function(t){return t+1===n.tutor.last_accounts.length?"":moment(n.tutor.last_accounts[t+1].date_end).subtract(1,"days").toDate()},n.getDay=function(t){var e;return e=moment(t).day()-1,e===-1&&(e=6),e},n.accountInfo=function(t){return n.popup_attachment=null,$("#account-info").modal("show"),n.selected_client=t,c.get({id:t.attachment_id},function(t){return n.popup_attachment=t})},n.changeDateDialog=function(t){return $("#date-end-change").datepicker("destroy"),$("#date-end-change").datepicker({language:"ru",autoclose:!0,orientation:"bottom auto",startDate:M(t),endDate:S(t)}),n.selected_account=n.tutor.last_accounts[t],n.dialog("change-account-date")},n.remove=function(t){return bootbox.confirm("<b>Удалить встречу?</b>",function(e){if(e===!0)return a["delete"]({id:t.id},function(){return n.tutor.last_accounts=removeById(n.tutor.last_accounts,t.id)})})},n.save=function(){return ajaxStart(),$.each(n.tutor.last_accounts,function(t,e){return a.update(e)}),ajaxEnd()},n.getFakeDates=function(){var t,e;for(e=[],t=moment().subtract(60,"days").format("YYYY-MM-DD");t<=moment().format("YYYY-MM-DD");)e.push(t),t=moment(t).add(1,"days").format("YYYY-MM-DD");return e},n.getDates=function(t){var e,r;for(r=[],e=t?moment(n.tutor.last_accounts[t-1].date_end).add(1,"days").format("YYYY-MM-DD"):n.date_limit;e<=n.tutor.last_accounts[t].date_end;)r.push(e),e=moment(e).add(1,"days").format("YYYY-MM-DD");return r},I=function(){var t;return n.tutor.last_accounts.length>0?(t=n.tutor.last_accounts[n.tutor.last_accounts.length-1].date_end,moment(t).add(1,"days").toDate()):new Date(n.date_limit)},n.addAccountDialog=function(){return n.new_account_date_end="",$("#date-end").datepicker("destroy"),$("#date-end").datepicker({language:"ru",startDate:I(),autoclose:!0,orientation:"bottom auto"}),n.dialog("add-account")},n.addPlannedAccountDialog=function(e){var r;(e||n.tutor.planned_account)&&(!n.tutor.planned_account||(r=!1,t.call(n.tutor.planned_account,r)>=0||!n.tutor.planned_account.id)?n.tutor.planned_account={is_planned:"0",payment_method:"0",date:""}:_.extend(n.tutor.planned_account,{is_planned:"1",tutor_id:n.tutor.id}),$("#pa-date").datepicker("destroy"),$("#pa-date").datepicker({language:"ru",autoclose:!0,orientation:"bottom auto"}),o(function(){return n.refreshSelects()}),$("#add-planned-account").modal("show"))},O=function(){var t;return t=!0,0!==parseInt(n.tutor.planned_account.is_planned)&&(!n.tutor.planned_account.user_id>0&&1===n.tutor.planned_account.payment_method?($("#pa-user .bootstrap-select").addClass("has-error"),t=!1):$("#pa-user .bootstrap-select").removeClass("has-error"),n.tutor.planned_account.date&&moment(n.tutor.planned_account.date,"DD.MM.YYYY").isValid()?$("#pa-date").removeClass("has-error"):($("#pa-date").addClass("has-error"),t=!1)),t},n.addPlannedAccount=function(){if(O())return n.tutor.planned_account.tutor_id=n.tutor.id,k.save(n.tutor.planned_account,function(t){n.tutor.planned_account.id=t.id,$("#add-planned-account").modal("hide")})},n.updatePlannedAccount=function(){O()&&(+n.tutor.planned_account.is_planned?k.update({id:n.tutor.planned_account.id,data:n.tutor.planned_account}):k["delete"]({id:n.tutor.planned_account.id},function(){return n.tutor.planned_account=null}),$("#add-planned-account").modal("hide"))},n.refreshSelects=function(){return o(function(){return $("#add-planned-account .selectpicker option").each(function(t,e){return $(e).data("subtext",$(e).attr("data-subtext")),$(e).data("content",$(e).attr("data-content"))}),$("#add-planned-account .selectpicker").selectpicker("refresh")},100)},n.addAccount=function(){return a.save({date_end:convertDate(n.new_account_date_end),tutor_id:n.tutor.id},function(t){return n.tutor.last_accounts.push(t),n.closeDialog("add-account")})},L=function(t){return t.indexOf("/")!==-1?(t=t.split("/")[1],t?parseInt(t):0):Math.round(.25*parseInt(t))},n.totalLessons=function(t,e){var r;return r=0,$.each(n.tutor.last_accounts,function(t,o){return r+=n.periodLessons(o,e)}),r||null},n.periodLessons=function(t,e){var n;return t.data[e]?(n=0,$.each(t.data[e],function(t,e){if(e)return n++}),n||null):null},n.totalCommission=function(t){var e;return e=0,$.each(t.data,function(t,n){return $.each(n,function(t,n){if(""!==n)return e+=L(n)})}),e},n.selectRow=function(t){$(".tr-"+t).addClass("selected")},n.deselectRow=function(t){$(".tr-"+t).removeClass("selected")},A=function(t,e,r){var o;switch(r){case"left":t--;break;case"right":t++;break;case"up":e=moment(e).subtract("days",1).format("YYYY-MM-DD");break;case"down":e=moment(e).add("days",1).format("YYYY-MM-DD")}t<0||!$("#i-"+e+"-"+t).length||(o=$("#i-"+e+"-"+t),o.length?(n.caret=0,o.focus()):A(t,e,r))},n.caret=0,n.periodsCursor=function(t,e,r,o,a){var i,u,s;if(s=$("#i-"+t+"-"+e),"0"===s.val()&&s.val().length)for(;;){if(i=moment(i||t).subtract("days",1).format("YYYY-MM-DD"),u=$("#i-"+i+"-"+e),!u.length)break;if(u.val()){r.preventDefault(),o[a]=u.val();break}}if(s.caret()!==n.caret)return void(n.caret=s.caret());switch(r.which){case 37:return A(e,t,"left");case 38:return A(e,t,"up");case 39:return A(e,t,"right");case 13:case 40:return A(e,t,"down")}},D=function(){return"hidden"===n.page?0:1},T=function(){return"hidden"===n.page?n.visible_clients_count++:n.hidden_clients_count++},n.toggleConfirmed=function(t,n){return e.toggleEnumServer(t,"confirmed",E,n)}})}.call(this),function(){angular.module("Egerep").controller("ActivityIndex",function(t,e,n,r,o){return bindArguments(t,arguments),n(function(){return t.search={},t.refreshCounts()}),t.formatMinutes=function(t){var e;return e=t>=60?"H час m мин":"m мин",moment.duration(t,"minutes").format(e)},t.refreshCounts=function(){return n(function(){return $(".selectpicker option").each(function(t,e){return $(e).data("subtext",$(e).attr("data-subtext")),$(e).data("content",$(e).attr("data-content"))}),$(".selectpicker").selectpicker("refresh")},300)},t.show=function(){return r.frontend_loading=!0,e.get("api/activity?"+$.param(t.search)).then(function(e){return r.frontend_loading=!1,r.frontendStop(),t.data=e.data})}})}.call(this),function(){var t=[].indexOf||function(t){for(var e=0,n=this.length;e<n;e++)if(e in this&&this[e]===t)return e;return-1};angular.module("Egerep").controller("AddToList",function(e,n,r,o,a,i,u,s,c){var d,l,f,m,p,g,h,v,y,b;return bindArguments(e,arguments),d=.3,f=0,p=void 0,e.mode="map",e.loading=!1,angular.element(document).ready(function(){return e.list=new c(e.list),$(".map-tutor-list").droppable()}),e.getHours=function(t){return Math.floor(t/60)},e.getMinutes=function(t){return t%60},e.find=function(){return e.loading=!0,u.getFiltered({search:e.search,client_marker:e.client.markers[0]}).then(function(t){return e.tutors=t.data,y(),m(),h(),e.loading=!1})},e.added=function(n){return t.call(e.list.tutor_ids.map(Number),n)>=0},g=function(){return $(".temporary-tutor").draggable({containment:"window",revert:function(t){return!!t||(e.tutor_list=removeById(e.tutor_list,e.dragging_tutor.id),e.$apply())}})},e.startDragging=function(t){return e.dragging_tutor=t},y=function(){return b(),e.marker_id=1,e.tutor_list=[],e.markers=[],e.tutors&&e.tutors.forEach(function(t){return t.markers.forEach(function(n){var r;return r=newMarker(e.marker_id++,new google.maps.LatLng(n.lat,n.lng),e.map,n.type),r.metros=n.metros,r.tutor=t,r.setMap(e.map),l(r),e.markers.push(r)})}),p=new MarkerClusterer(e.map,e.markers,{gridSize:10,imagePath:"img/maps/clusterer/m"})},v=function(){return e.client.markers.forEach(function(t){var n;return n=newMarker(e.marker_id++,new google.maps.LatLng(t.lat,t.lng),e.map,"white"),n.metros=t.metros,n.setMap(e.map)})},b=function(){if(void 0!==e.markers&&e.markers.forEach(function(t){return t.setMap(null)}),void 0!==p)return p.clearMarkers()},m=function(){if("r_k"===e.search.destination)return e.markers.forEach(function(n){return n.intersecting=!1,e.client.markers.forEach(function(e){return e.metros.forEach(function(e){var r;r=e.station_id,t.call(n.tutor.svg_map,r)>=0&&(n.intersecting=!0,n.tutor.intersecting=!0)})})}),e.markers.forEach(function(t){if(!t.intersecting)return t.setOpacity(d)})},e.intersectingTutors=function(){return _.where(e.tutors,{intersecting:!0})},e.notIntersectingTutors=function(){return _.filter(e.tutors,function(t){return _.isUndefined(t.intersecting)})},l=function(n){return google.maps.event.addListener(n,"click",function(r){if(f++,1===f)return setTimeout(function(){var r;return 1===f?(r=n.tutor,t.call(e.tutor_list,r)>=0?e.tutor_list=removeById(e.tutor_list,n.tutor.id):(e.hovered_tutor=null,e.tutor_list.push(n.tutor)),e.$apply(),g()):e.addOrRemove(n.tutor.id),f=0},250)}),google.maps.event.addListener(n,"dblclick",function(t){return f++}),google.maps.event.addListener(n,"mouseover",function(r){var o;if(o=n.tutor,!(t.call(e.tutor_list,o)>=0))return e.hovered_tutor=n.tutor,e.$apply()}),google.maps.event.addListener(n,"mouseout",function(t){return e.hovered_tutor=null,e.$apply()})},e.addOrRemove=function(n){return n=parseInt(n),t.call(e.list.tutor_ids.map(Number),n)>=0?e.list.tutor_ids=_.without(e.list.tutor_ids.map(Number),n):e.list.tutor_ids.push(n),h(),e.list.$update()},h=function(){return e.markers.forEach(function(n){var r,o;if(r=n.tutor.id,t.call(e.list.tutor_ids.map(Number),r)>=0&&!n.chosen&&(n.chosen=!0,n.setOpacity(1),n.setIcon(ICON_BLUE)),o=n.tutor.id,t.call(e.list.tutor_ids.map(Number),o)<0&&n.chosen)return n.chosen=!1,n.setOpacity(n.intersecting?1:d),n.setIcon(getMarkerType(n.type))})},e.$on("mapInitialized",function(t,n){var r;return e.gmap=n,r={lat:55.7387,lng:37.6032},e.RECOM_BOUNDS=new google.maps.LatLngBounds(new google.maps.LatLng(r.lat-.5,r.lng-.5),new google.maps.LatLng(r.lat+.5,r.lng+.5)),e.geocoder=new google.maps.Geocoder,e.gmap.setCenter(new google.maps.LatLng(55.7387,37.6032)),e.gmap.setZoom(11),v(),e.tutors=e.list.tutors,y(),h()})})}.call(this),function(){angular.module("Egerep").factory("Archives",function(t){return t("api/archives/:id",{},{update:{method:"PUT"}})}).controller("ArchivesIndex",function(t,e,n,r,o,a,i,u,s,c,d,l,f,m,p){var g,h;return bindArguments(e,arguments),t.frontend_loading=!0,h=function(){return n(function(){return $(".selectpicker option").each(function(t,e){return $(e).data("subtext",$(e).attr("data-subtext")),$(e).data("content",$(e).attr("data-content"))}),$(".selectpicker").selectpicker("refresh")},100)},e.keyFilter=function(t){if(13===t.keyCode)return e.filter()},e.filter=function(){return $.cookie("archives",JSON.stringify(e.search),{expires:365,path:"/"}),e.current_page=1,e.pageChanged()},e.changeState=function(n){return t.frontend_loading=!0,e.archives=[],e.current_page=1,g(e.current_page),window.history.pushState(n,"","archives/"+n.toLowerCase())},n(function(){return e.search=$.cookie("archives")?JSON.parse($.cookie("archives")):{},g(e.page),e.current_page=e.page}),e.pageChanged=function(){return t.frontend_loading=!0,t.archives=[],g(e.current_page),paginate("archives",e.current_page)},g=function(n){var o;return o="?page="+n,r.get("api/archives"+o).then(function(n){return e.data=n.data.data,e.archives=n.data.data.data,e.counts=n.data.counts,t.frontend_loading=!1,h()})}})}.call(this),function(){angular.module("Egerep").factory("Attachment",function(t){return t("api/attachments/:id",{},{update:{method:"PUT"}})}).controller("AttachmentsStats",function(t,e,n,r,o,a){return t.getYears=function(){var t,e,n;for(t=4,e=0,n=[];e<t;)n.push(moment().subtract("year",e).format("YYYY")),e++;return n},t.getUsersByYear=function(e){return _.chain(t.data).where({year:parseInt(e)}).pluck("user_id").uniq().value()},t.getDays=function(){return _.range(1,32)},t.dayExtremum=function(e,n,r,o){var a,i,u,s,c;return!!r&&(a={year:parseInt(n)},null!==e&&(a.day=parseInt(e)),i=_.where(t.data,a),s=-999,c=999,i.forEach(function(t){if(t.count>s&&(s=t.count),t.count<c)return c=t.count}),u="max"===o?s:c,null===e&&console.log(u,r,n),r===u)},t.totalExtremum=function(e,n){var r,o;return!!n&&(o=t.getUsersByYear(e),!!o.length&&(r=-9999,o.forEach(function(n){var o;if(o=t.getUserTotal(e,n),o>r)return r=o}),n===r))},t.getUserTotal=function(e,n){var r,o;return r=_.where(t.data,{year:parseInt(e),user_id:parseInt(n)}),o=0,r.forEach(function(t){return o+=t.count}),o||""},t.getDayTotal=function(e,n){var r,o,a;return null==n&&(n=null),r={year:parseInt(e)},null!==n&&(r.day=parseInt(n)),o=_.where(t.data,r),a=0,o.forEach(function(t){return a+=t.count}),a||""},t.getValue=function(t,e,n){var r;return r=_.find(scope.data,{day:parseInt(t),year:parseInt(e),user_id:parseInt(n)}),void 0!==r?r.count:""},t.$watch("month",function(r,o){return e.frontend_loading=!0,n.post("api/attachments/stats",{month:r}).then(function(n){return e.frontend_loading=!1,t.data=n.data})}),bindArguments(t,arguments)}).controller("AttachmentsIndex",function(t,e,n,r,o,a,i,u,s,c,d,l,f,m){var p,g;return bindArguments(e,arguments),t.frontend_loading=!0,e.recalcAttachmentErrors=function(){return e.attachment_errors_updating=!0,r.post("api/command/model-errors",{model:"attachments"})},g=function(){return n(function(){return $(".selectpicker option").each(function(t,e){return $(e).data("subtext",$(e).attr("data-subtext")),$(e).data("content",$(e).attr("data-content"))}),$(".selectpicker").selectpicker("refresh"),$(".attachment-filters button").css("background","none"),$('.attachment-filters select > option[value!=""]:selected').parent("select").siblings("button").css("background","#dceee5")},100)},e.filter=function(){return $.cookie("attachments",JSON.stringify(e.search),{expires:365,path:"/"}),e.current_page=1,e.pageChanged()},e.changeState=function(n){return t.frontend_loading=!0,e.attachments=[],e.current_page=1,p(e.current_page),window.history.pushState(n,"","attachments/"+n.toLowerCase())},n(function(){return e.search=$.cookie("attachments")?JSON.parse($.cookie("attachments")):{},p(e.page),e.current_page=e.page}),e.pageChanged=function(){return t.frontend_loading=!0,t.attachments=[],p(e.current_page),paginate("attachments",e.current_page)},p=function(n){var o;return o="?page="+n,r.get("api/attachments"+o).then(function(n){return e.data=n.data.data,e.attachments=n.data.data.data,e.counts=n.data.counts,t.frontend_loading=!1,g()})}}).controller("AttachmentsNew",function(t,e,n,r,o,a,i,u,s,c,d,l,f,m){var p;return bindArguments(e,arguments),t.frontend_loading=!0,t.loaded_comments=0,e.$watch(function(){return console.log(t.loaded_comments),t.loaded_comments},function(n){if(console.log(n),e.attachments&&e.attachments.length===n)return t.frontend_loading=!1}),e.daysAgo=function(t){var e;return e=moment(Date.now()),t=moment(new Date(t).getTime()),e.diff(t,"days")},n(function(){return p(e.page),e.current_page=e.page}),e.pageChanged=function(){return t.frontend_loading=!0,t.loaded_comments=0,p(e.current_page),paginate("attachments/new",e.current_page)},p=function(n){var o;return o="?page="+n,r.get("api/attachments/new"+o).then(function(n){if(console.log(n),e.counts=n.data.counts,e.data=n.data,e.attachments=n.data.data,!e.attachments.length)return t.frontend_loading=!1})}})}.call(this),function(){angular.module("Egerep").controller("Attendance",function(t,e,n,r,o){return bindArguments(t,arguments),t.getDays=function(){return _.range(1,32)},t.late=function(t){return t&&parseInt(t.replace(/\D/g,""))>5},t.formatYearMonth=function(t){return moment(t+"-01").format("MMMM YYYY")},t.$watch("month",function(r,o){return e.frontend_loading=!0,n.post("api/attendance",{month:r}).then(function(n){return e.frontend_loading=!1,t.data=n.data})})})}.call(this),function(){angular.module("Egerep").controller("Background",function(t,e,n,r){return bindArguments(t,arguments),t.editBackgroundModal=function(e){return t.modal_background=_.clone(t.backgrounds[e]),$("#edit-background").modal("show")},t.editBackground=function(){$.each(t.backgrounds,function(e,n){n.id===t.modal_background.id&&(t.backgrounds[e]=t.modal_background)}),n.update({id:t.modal_background.id},t.modal_background),$("#edit-background").modal("hide")},t.loadImage=function(e){t.date=e,$("#fileupload").fileupload({formData:{date:e}}),$("#fileupload").click()},t.remove=function(e){return n["delete"]({id:t.backgrounds[e].id}),delete t.backgrounds[e]},t.pageChanged=function(){return ajaxStart(),redirect("background?page="+t.current_page)},e(function(){return t.today_date=moment().format("YYYY-MM-DD"),$("#fileupload").fileupload({maxFileSize:1e7,send:function(){return NProgress.configure({showSpinner:!0})},progress:function(t,e){return NProgress.set(e.loaded/e.total)},always:function(){return NProgress.configure({showSpinner:!1}),ajaxEnd()},done:function(e,n){return n.result.hasOwnProperty("error")?void notifyError(n.result.error):(t.backgrounds[t.date]=n.result,t.$apply())}})})})}.call(this),function(){angular.module("Egerep").controller("CallsIndex",function(t,e,n,r,o,a,i){var u,s;return bindArguments(e,arguments),t.frontend_loading=!0,e.formatTimestamp=function(t){return moment.unix(t).format("DD.MM.YY HH:mm")},e.callDuration=function(t){var e,n;return"0"===t.answer?"":(n=t.finish-t.answer,e="s сек",n>60&&(e="m мин "+e),n>3600&&(e="H час "+e),moment.duration(n,"seconds").format(e))},e.filter=function(){return e.current_page=1,e.pageChanged()},e.keyFilter=function(t){if(13===t.keyCode)return e.filter()},n(function(){return e.search={},u(e.page),e.current_page=e.page}),e.pageChanged=function(){return t.frontend_loading=!0,u(e.current_page),paginate("calls",e.current_page)},u=function(n){var o;return o=_.clone(e.search),o.page=n,r.get("api/calls?"+$.param(o)).then(function(n){return console.log(n),e.data=n.data.data,e.calls=n.data.data.data,t.frontend_loading=!1})},s=function(t){var e,n,r,o,a;return e="goea67jyo7i63nf4xdtjn59npnfcee5l",n="t9mp7vdltmhn0nhnq0x4vwha9ncdr8pa",a=moment().add(5,"minute").unix(),r=new jsSHA("SHA-256","TEXT"),r.update(e+a+t+n),o=r.getHash("HEX"),"https://app.mango-office.ru/vpbx/queries/recording/link/"+t+"/play/"+e+"/"+a+"/"+o},e.intervalStart=function(){return e.interval=i(function(){if(e.audio&&(e.current_time=angular.copy(e.audio.currentTime),e.prc=(100*e.current_time/e.audio.duration).toFixed(2),100===parseInt(e.prc)))return e.stop()},10)},e.intervalCancel=function(){return i.cancel(e.interval)},e.initAudio=function(t){return e.is_playing&&e.stop(),e.audio=new Audio(s(t)),e.current_time=0,e.prc=0,e.is_playing_stage="start",e.is_playing=t},e.pause=function(){return e.intervalCancel(),e.audio&&e.audio.pause(),e.is_playing_stage="pause"},e.play=function(t){return e.isPlaying(t)||e.initAudio(t),"play"===e.is_playing_stage?e.pause():(e.audio.play(),e.is_playing_stage="play",e.intervalStart())},e.isPlaying=function(t){return e.is_playing===t},e.stop=function(){return e.prc=0,e.is_playing=null,e.audio.pause(),e.audio=null,e.is_playing_stage="stop",e.intervalCancel()},e.setCurentTime=function(t){var n,r;return r=angular.element(t.target).width(),e.prc=100*t.offsetX/r,n=e.audio.duration*e.prc/100,e.audio.currentTime=n}}).controller("CallsMissed",function(t,e,n){return bindArguments(t,arguments),t.deleteCall=function(n){return ajaxStart(),e["delete"]("calls/"+n.entry_id,{}).then(function(e){return ajaxEnd(),t.calls=_.without(t.calls,n)})}})}.call(this),function(){var t=[].indexOf||function(t){for(var e=0,n=this.length;e<n;e++)if(e in this&&this[e]===t)return e;return-1};angular.module("Egerep").controller("ClientsIndex",function(t,e,n,r,o,a,i){var u;return e.frontend_loading=!0,t.pageChanged=function(){return u(t.current_page),paginate("clients",t.current_page)},u=function(n){var o;return e.frontend_loading=!0,o="?page="+n,t.global_search&&(o+="&global_search="+t.global_search),r.get("api/clients"+o).then(function(n){return e.frontendStop(),t.data=n.data,t.clients=t.data.data})},n(function(){return u(t.page),t.current_page=t.page})}).controller("ClientsForm",function(e,n,r,o,a,i,u,s,c,d,l,f,m,p,g,h,v,y,b,k,w,x,E,C,S,M,I,L){var D,A,Y,T,O,q,N,j,R,B,P;return bindArguments(e,arguments),n.frontend_loading=!0,e.is_dragging_teacher=!1,e.sortableOptions={tolerance:"pointer",activeClass:"drag-active",helper:"clone",appendTo:"body",start:function(t,n){return e.is_dragging_teacher=!0,e.$apply()},stop:function(t,n){return e.is_dragging_teacher=!1,e.$apply(),N()}},e.selectGrade=function(t){return t===e.client.grade?e.client.grade=0:(e.client.year||(e.client.year=e.academic_year),e.client.grade=t)},e.selectYear=function(t){return t===e.client.year?e.client.year=null:e.client.year=t},e.getRealGrade=function(){var t,n;if(e.client)return e.client.grade?e.client.year&&e.client.grade<12?(n=e.academic_year-e.client.year,t=parseInt(e.client.grade)+n,t>12?12:t):e.client.grade:0},e.edit=function(){return Y(),e.ajaxStart(),e.client.$update().then(function(t){return t.grade=t.grade_clean,e.client=t,e.loadMarkers(),e.ajaxEnd(),r(function(){return q()})})},q=function(){if(e.selected_request&&_.each(e.client.requests,function(t){if(e.selected_request.id===t.id)return e.selectRequest(t,!0)}),e.selected_list&&_.each(e.selected_request.lists,function(t){if(e.selected_list.id===t.id)return e.setList(t,!0)}),e.selected_attachment)return _.each(e.selected_list.attachments,function(t){if(e.selected_attachment.id===t.id)return e.selectAttachment(t)})},e.save=function(){return Y(),e.ajaxStart(),e.Client.save(e.client,function(t){return window.location="requests/"+t.id+"/edit"})},D=function(){return r(function(){return $(".teacher-remove-droppable").droppable({tolerance:"pointer",hoverClass:"drop-hover",drop:function(t,n){var o;return o=$(n.draggable).data("id"),r(function(){return e.selected_list.tutor_ids=_.without(e.selected_list.tutor_ids,o.toString()),N()})}})})},r(function(){return e.users=c.query(),a.get("api/tutors/list").success(function(t){return e.tutors=t}),e.id>0?i.get({id:e.id},function(t){return e.selected_request=e.request_id?_.findWhere(t.requests,{id:e.request_id}):t.requests[0],e.parseHash(),sp("list-subjects","выберите предмет"),n.frontendStop(),t.grade=t.grade_clean,e.client=t}):(e.client=e.new_client,e.client.requests=[e.new_request],e.selected_request=e.client.requests[0],n.frontendStop())}),N=function(){return s.update(e.selected_list)},e.getTutorList=function(){var t;if(t=[],e.selected_list)return $.each(e.selected_list.tutor_ids,function(n,r){return t.push(findById(e.selected_list.tutors,r))}),t},e.parseHash=function(){var t;if(t=window.location.hash.split("#"),t.shift(),t[0]&&(e.selected_list=findById(e.selected_request.lists,t[0])),t[1]&&e.selected_list)return e.selected_attachment=findById(e.selected_list.attachments,t[1])},e.toggleArchive=function(){return e.selected_attachment.archive?y["delete"](e.selected_attachment.archive,function(){return delete e.selected_attachment.archive}):y.save({attachment_id:e.selected_attachment.id},function(t){return rebindMasks(),e.selected_attachment.archive=t})},e.toggleReview=function(){return e.selected_attachment.review?b["delete"](e.selected_attachment.review,function(){return delete e.selected_attachment.review}):b.save({attachment_id:e.selected_attachment.id},function(t){return e.selected_attachment.review=t})},e.attachmentExists=function(t){var n;return n=!1,$.each(e.client.requests,function(e,r){if(!n)return $.each(r.lists,function(e,r){return $.each(r.attachments,function(e,r){if(parseInt(r.tutor_id)===parseInt(t))return n=!0})})}),n},e.selectAttachment=function(t){return e.selected_attachment=t},e.addList=function(){return e.dialog("add-subject")},e.setList=function(t,n){if(e.selected_list=t,e.list_map&&e.showListMap(),!n)return delete e.selected_attachment},e.listExists=function(t){return void 0!==_.findWhere(e.selected_request.lists,{
subject_id:parseInt(t)})},e.selectRequest=function(t,n){if(e.selected_request=t,!n)return delete e.selected_list},e.addListSubject=function(){s.save({request_id:e.selected_request.id,subjects:e.list_subjects},function(t){return e.selected_request.lists.push(t),e.selected_list=t}),delete e.list_subjects,spRefresh("list-subjects"),$("#add-subject").modal("hide")},e.addListTutor=function(){return e.selected_list.tutor_ids.push(e.list_tutor_id),s.update({id:e.selected_list.id,tutor_ids:e.selected_list.tutor_ids},function(){return delete e.list_tutor_id,$("#add-tutor").modal("hide")})},e.newAttachment=function(t){return ajaxStart(),m.save({grade:e.getRealGrade(),tutor_id:t,subjects:e.selected_list.subjects,request_list_id:e.selected_list.id,client_id:e.client.id},function(t){if(ajaxEnd(),t.id)return e.selected_attachment=t,e.selected_list.attachments.push(t)})},e.addRequest=function(){var t;return t=new u({client_id:e.id}),ajaxStart(),t.$save().then(function(t){return ajaxEnd(),e.client.requests.push(t),e.selected_request=t,P(!1,!0,!0)})},e.removeRequest=function(){return bootbox.confirm("Вы уверены, что хотите удалить заявку?",function(t){if(t===!0)return u["delete"]({id:e.selected_request.id},function(){return e.client.requests=removeById(e.client.requests,e.selected_request.id),P(!0,!0,!0)})})},e.transferRequest=function(){return $("#transfer-request").modal("show")},e.transferRequestGo=function(){return $("#transfer-request").modal("hide"),ajaxStart(),a.post("api/requests/transfer/"+e.selected_request.id,{client_id:e.transfer_client_id}).then(function(t){return ajaxEnd(),console.log(t),""!==t.data?location.reload():bootbox.alert("Клиент не существует")})},P=function(t,n,r){if(null==t&&(t=!1),null==n&&(n=!1),null==r&&(r=!1),t&&(e.selected_request=null),n&&(e.selected_list=null),r)return e.selected_attachment=null},e.removeList=function(){return bootbox.confirm("Вы уверены, что хотите удалить список?",function(t){if(t===!0)return s["delete"]({id:e.selected_list.id},function(){return e.selected_request.lists=removeById(e.selected_request.lists,e.selected_list.id),delete e.selected_list,P(!1,!0,!0)})})},e.removeAttachment=function(){return bootbox.confirm("Вы уверены, что хотите удалить стыковку?",function(t){if(t===!0)return m["delete"]({id:e.selected_attachment.id},function(){return e.selected_list.attachments=removeById(e.selected_list.attachments,e.selected_attachment.id),delete e.selected_attachment,P(!1,!1,!0)})})},e.$watch("selected_request.comment",function(t,n){var r;if(void 0!==t||void 0!==n)return void 0===t&&(t=n),e.request_tutor_ids=[],r=t.match(/Репетитор [\d]+/gi),$.each(r,function(t,n){var r;return r=n.match(/[\d]+/gi),e.request_tutor_ids.push(parseInt(r))})}),e.$watch("selected_attachment",function(t,e){if(void 0!==t)return void 0===e&&sp("attachment-subjects","выберите предмет"),void 0!==e&&spRefresh("attachment-subjects"),rebindMasks()}),e.$watch("selected_list",function(t,e){if(void 0===e&&void 0!==t)return D()}),e.marker_id=1,e.map_number=0,Y=function(){var t;return t=[],$.each(e.client.markers,function(e,n){return t.push(_.pick(n,"lat","lng","type","metros","server_id"))}),e.client.markers=t},e.$on("mapInitialized",function(t,n){var r;return n.number=e.map_number,0===e.map_number?(e.gmap=n,e.loadMarkers(),r={lat:55.7387,lng:37.6032},e.RECOM_BOUNDS=new google.maps.LatLngBounds(new google.maps.LatLng(r.lat-.5,r.lng-.5),new google.maps.LatLng(r.lat+.5,r.lng+.5)),e.geocoder=new google.maps.Geocoder,google.maps.event.addListener(n,"click",function(t){return e.gmapAddMarker(t)})):(e.gmap2=n,e.gmap2.setCenter(new google.maps.LatLng(55.7387,37.6032)),e.gmap2.setZoom(11)),e.map_number++}),e.showMap=function(){var t,n;if($("#gmap-modal").modal("show"),google.maps.event.trigger(e.gmap,"resize"),e.gmap.setCenter(new google.maps.LatLng(55.7387,37.6032)),e.gmap.setZoom(11),$("#map-search").val(""),e.search_markers&&e.search_markers.length&&($.each(e.search_markers,function(t,e){return e.setMap(null)}),e.search_markers=[]),e.client.markers.length&&(t=new google.maps.LatLngBounds,n=0,$.each(e.client.markers,function(e,r){return n++,t.extend(r.position)}),n>0))return e.gmap.fitBounds(t),e.gmap.panToBounds(t),e.gmap.setZoom(11)},e.gmapAddMarker=function(t){var n;return n=newMarker(e.marker_id++,t.latLng,e.gmap),e.client.markers.push(n),n.setMap(e.gmap),k.metro("closest",{lat:n.lat,lng:n.lng}).then(function(t){return n.metros=t.data}),e.bindMarkerDelete(n),e.bindMarkerChangeType(n)},e.bindMarkerDelete=function(t){return google.maps.event.addListener(t,"dblclick",function(t){var n;return n=this,n.setMap(null),$.each(e.client.markers,function(t,r){if(void 0!==r&&n.id===r.id)return void 0!==r.server_id&&(ajaxStart(),S["delete"]({id:r.server_id},function(){return ajaxEnd()})),e.client.markers.splice(t,1)})})},e.bindMarkerChangeType=function(t){return!1},e.searchMap=function(t){return e.geocoder.geocode({address:t+", московская область",bounds:e.RECOM_BOUNDS,componentRestrictions:{country:"RU",administrativeArea:"Moscow"}},function(t,n){var r,o;if(n===google.maps.GeocoderStatus.OK){if(r=3,o=new google.maps.LatLngBounds,$.each(t,function(t,n){var a;if(!(t>=r))return o.extend(n.geometry.location),a=new google.maps.Marker({map:e.gmap,position:n.geometry.location,icon:ICON_SEARCH}),google.maps.event.addListener(a,"click",function(t){return this.setMap(null),e.gmapAddMarker(t)}),e.search_markers=initIfNotSet(e.search_markers),e.search_markers.push(a)}),!(t.length>0))return $("#map-search").addClass("has-error").focus();if(e.gmap.fitBounds(o),e.gmap.panToBounds(o),1===t.length)return e.gmap.setZoom(12)}})},e.gmapsSearch=function(t){if(13===t.keyCode||"click"===t.type)return""===$("#map-search").val()?$("#map-search").addClass("has-error").focus():$("#map-search").removeClass("has-error"),e.searchMap($("#map-search").val())},e.loadMarkers=function(){return n.dataLoaded.promise.then(function(){var t;return t=[],$.each(e.client.markers,function(n,r){var o;return o=newMarker(e.marker_id++,new google.maps.LatLng(r.lat,r.lng),e.gmap,r.type,r.id),o.metros=r.metros,o.setMap(e.gmap),console.log("adding marker",e.gmap),e.bindMarkerDelete(o),e.bindMarkerChangeType(o),t.push(o)}),e.client.markers=_.sortBy(t,function(t){return t.server_id})})},e.saveMarkers=function(){$("#gmap-modal").modal("hide"),Y()},e.listMap=function(){return e.list_map=!e.list_map,e.showListMap()},e.added=function(n){return t.call(e.tutor_ids.map(Number),n)>=0},T=function(){return $(".temporary-tutor").draggable({containment:"window",revert:function(t){return!!t||(e.tutor_list=removeById(e.tutor_list,e.dragging_tutor.id),e.tutor_ids=_.without(e.tutor_ids.map(Number),e.dragging_tutor.id),e.$apply(),O())}})},e.startDragging=function(t){return e.dragging_tutor=t},R=function(){var t,n;return B(),e.marker_id2=1,e.tutor_list=[],t=new google.maps.LatLngBounds,n=0,e.markers2=[],google.maps.event.trigger(e.gmap2,"resize"),e.gmap2.setCenter(new google.maps.LatLng(55.7387,37.6032)),e.gmap2.setZoom(11),e.client.markers.forEach(function(e){return n++,t.extend(new google.maps.LatLng(e.lat,e.lng))}),e.selected_list.tutors.forEach(function(r){return r.markers.forEach(function(o){var a;return n++,t.extend(new google.maps.LatLng(o.lat,o.lng)),a=newMarker(e.marker_id2++,new google.maps.LatLng(o.lat,o.lng),e.gmap2,o.type),a.metros=o.metros,a.tutor=r,a.setMap(e.gmap2),A(a),e.markers2.push(a)})}),n>0&&(e.gmap2.fitBounds(t),e.gmap2.panToBounds(t),e.gmap2.setZoom(10)),e.gmap2.panBy(150,0)},j=function(){return e.client.markers.forEach(function(t){var n;return n=newMarker(e.marker_id2++,new google.maps.LatLng(t.lat,t.lng),e.gmap2,"white"),n.metros=t.metros,n.setMap(e.gmap2)})},B=function(){if(void 0!==e.markers2)return e.markers2.forEach(function(t){return t.setMap(null)})},A=function(n){return google.maps.event.addListener(n,"click",function(r){var o;return o=n.tutor,t.call(e.tutor_list,o)>=0?e.tutor_list=removeById(e.tutor_list,n.tutor.id):(e.hovered_tutor=null,e.tutor_list.push(n.tutor)),e.addOrRemove(n.tutor.id),e.$apply(),T()}),google.maps.event.addListener(n,"mouseover",function(r){var o;if(o=n.tutor,!(t.call(e.tutor_list,o)>=0))return e.hovered_tutor=n.tutor,e.$apply()}),google.maps.event.addListener(n,"mouseout",function(t){return e.hovered_tutor=null,e.$apply()})},e.addOrRemove=function(n){return n=parseInt(n),void 0===e.tutor_ids&&(e.tutor_ids=[]),t.call(e.tutor_ids.map(Number),n)>=0?e.tutor_ids=_.without(e.tutor_ids.map(Number),n):e.tutor_ids.push(n),O()},O=function(){return e.markers2.forEach(function(n){var r,o;if(r=n.tutor.id,t.call(e.tutor_ids.map(Number),r)>=0&&!n.chosen&&(n.chosen=!0,n.setIcon(ICON_BLUE)),o=n.tutor.id,t.call(e.tutor_ids.map(Number),o)<0&&n.chosen)return n.chosen=!1,n.setIcon(getMarkerType(n.type))})},e.showListMap=function(){return r(function(){return R(),j()})}})}.call(this),function(){var t=[].indexOf||function(t){for(var e=0,n=this.length;e<n;e++)if(e in this&&this[e]===t)return e;return-1};angular.module("Egerep").controller("DebtMap",function(e,n,r,o,a,i){var u,s,c,d,l,f,m,p,g,h,v,y;return bindArguments(e,arguments),s=.5,u=1,d=0,m=void 0,e.mode="map",e.loading=!1,e.search={},e.tutor_ids=[],e.sortType="debt_calc",e.sortReverse=!1,e.$watch("mode",function(t,n){if("debtor"===t&&void 0===e.debtors)return r.getDebtors().then(function(t){return e.debtors=t.data})}),e.totalLastDebt=function(){var t,n;return t=0,n="list"===e.mode?e.tutors:e.debtors,$.each(n,function(e,n){var r;if(null!==n.last_account_info)return r=n.last_account_info.debt,t+=n.last_account_info.debt_type?+r:-r}),{debt_type:t<0?0:1,debt:Math.abs(t)}},e.blurComment=function(t){return t.is_being_commented=!1,t.debt_comment=t.old_debt_comment},e.focusComment=function(t){return t.is_being_commented=!0,t.old_debt_comment=t.debt_comment},e.startComment=function(t){return t.is_being_commented=!0,t.old_debt_comment=t.debt_comment,n(function(){return $("#list-comment-"+t.id).focus()})},e.saveComment=function(t,e){if(13===t.keyCode)return o.update({id:e.id,debt_comment:e.debt_comment},function(n){return e.old_debt_comment=e.debt_comment,$(t.target).blur()})},angular.element(document).ready(function(){return $(".map-tutor-list").droppable()}),e.find=function(){return e.loading=!0,e.tutor_ids=[],r.getDebtMap({search:e.search}).then(function(t){return e.tutors=t.data,angular.forEach(e.tutors,function(t){return t.last_account_info?t.last_debt=t.last_account_info.debt_type?t.last_account_info.debt:-t.last_account_info.debt:t.last_debt=0}),v(),e.loading=!1})},e.added=function(n){return t.call(e.tutor_ids,n)>=0},p=function(){return $(".temporary-tutor").draggable({containment:"window",appendTo:"body",helper:"clone",revert:function(t){return!!t||(e.tutor_list=removeById(e.tutor_list,e.dragging_tutor.id),e.tutor_ids=_.without(e.tutor_ids,e.dragging_tutor.id),e.$apply(),g())},start:function(){return e.isDragging=!0,e.$apply()},stop:function(t,n){return n.helper.remove(),e.isDragging=!1,e.$apply()}})},e.startDragging=function(t){return e.dragging_tutor=t},v=function(){return y(),e.marker_id=1,e.tutor_list=[],e.markers=[],e.tutors.forEach(function(t){return t.markers.forEach(function(n){var r;return r=newMarker(e.marker_id++,new google.maps.LatLng(n.lat,n.lng),e.map,"semi-black"),r.metros=n.metros,r.tutor=t,r.setOpacity(f(r)),r.setMap(e.map),c(r),e.markers.push(r)})}),m=new MarkerClusterer(e.map,e.markers,{gridSize:10,imagePath:"img/maps/clusterer/m"}),g()},h=function(){return e.client.markers.forEach(function(t){var n;return n=newMarker(e.marker_id++,new google.maps.LatLng(t.lat,t.lng),e.map,"white"),n.metros=t.metros,n.setMap(e.map)})},y=function(){if(void 0!==e.markers&&e.markers.forEach(function(t){return t.setMap(null)}),void 0!==m)return m.clearMarkers()},l=function(){if("r_k"===e.search.destination)return e.markers.forEach(function(n){return n.intersecting=!1,e.client.markers.forEach(function(e){return e.metros.forEach(function(e){var r;r=e.station_id,t.call(n.tutor.svg_map,r)>=0&&(n.intersecting=!0,n.tutor.intersecting=!0)})})}),e.markers.forEach(function(t){if(!t.intersecting)return t.setOpacity(u)})},e.intersectingTutors=function(){return _.where(e.tutors,{intersecting:!0})},e.notIntersectingTutors=function(){return _.filter(e.tutors,function(t){return _.isUndefined(t.intersecting)})},c=function(n){return google.maps.event.addListener(n,"click",function(r){var o;return o=n.tutor,t.call(e.tutor_list,o)>=0?e.tutor_list=removeById(e.tutor_list,n.tutor.id):(e.hovered_tutor=null,e.tutor_list.push(n.tutor)),e.addOrRemove(n.tutor.id),e.$apply(),p()}),google.maps.event.addListener(n,"mouseover",function(r){var o;if(o=n.tutor,!(t.call(e.tutor_list,o)>=0))return e.hovered_tutor=n.tutor,e.$apply()}),google.maps.event.addListener(n,"mouseout",function(t){return e.hovered_tutor=null,e.$apply()})},e.addOrRemove=function(n){return n=parseInt(n),t.call(e.tutor_ids,n)>=0?e.tutor_ids=_.without(e.tutor_ids,n):e.tutor_ids.push(n),g()},g=function(){return e.markers.forEach(function(n){var r,o;if(r=n.tutor.id,t.call(e.tutor_ids,r)>=0&&!n.chosen&&(n.chosen=!0,n.setIcon(ICON_BLACK),n.setOpacity(f(n))),o=n.tutor.id,t.call(e.tutor_ids,o)<0&&n.chosen&&(n.chosen=!1,n.setIcon(ICON_SEMI_BLACK)),n.tutor.planned_account)return n.setIcon(ICON_YELLOW),n.setIcon(ICON_SEMI_BLACK),n.setOpacity(f(n))})},f=function(t){return t.tutor.planned_account&&s||u},e.$on("mapInitialized",function(t,n){var r;return e.gmap=n,r={lat:55.7387,lng:37.6032},e.RECOM_BOUNDS=new google.maps.LatLngBounds(new google.maps.LatLng(r.lat-.5,r.lng-.5),new google.maps.LatLng(r.lat+.5,r.lng+.5)),e.geocoder=new google.maps.Geocoder,e.gmap.setCenter(new google.maps.LatLng(55.7387,37.6032)),e.gmap.setZoom(11)})})}.call(this),function(){angular.module("Egerep").controller("EmptyCtrl",function(){})}.call(this),function(){angular.module("Egerep").controller("GoogleIdsController",function(t,e,n,r){return bindArguments(t,arguments),t.google_ids="",t.loading=!1,t.show=function(){return r.frontend_loading=!0,n.post("api/google-ids",{google_ids:t.google_ids}).then(function(e){return console.log(e),t.data=e.data.result,t.totals=e.data.totals,r.frontend_loading=!1})}})}.call(this),function(){angular.module("Egerep").controller("GraphController",function(t,e,n,r){var o,a,i;return bindArguments(t,arguments),t.map_loaded=!1,t.selected=[],i=function(t){return parseInt($(t).attr("id").replace(/[^\d]/g,""))},angular.element(document).ready(function(){return e(function(){return $("#stations > g > g").each(function(e,n){return $(n).on("mouseenter",function(){return t.hovered_station_id=i(this),t.$apply()}),$(n).on("mouseleave",function(){return t.hovered_station_id=void 0,t.$apply()}),$(n).on("click",function(){return 2===t.selected.length&&(t.selected=[]),t.selected.push(i(this)),2===t.selected.length&&(t.new_distance=o(t.selected[0],t.selected[1])),t.$apply()})}),t.map_loaded=!0},500)}),t.$watch("hovered_station_id",function(e,n){var r;if(void 0!==e)return r=_.filter(t.distances,function(t){return t.from===e||t.to===e}),t.found_distances=_.map(r,_.clone),angular.forEach(t.found_distances,function(t){var n;if(t.from!==e)return n=t.from,t.from=e,t.to=n})}),t.save=function(){var e,o;return e=t.selected[0],o=t.selected[1],r.ajaxStart(),n.post("graph/save",{from:e,to:o,distance:t.new_distance}).then(function(){var n;return n=a(e,o),void 0===n?t.distances.push({from:e,to:o,distance:t.new_distance}):n.distance=t.new_distance,r.ajaxEnd()})},t["delete"]=function(){var e,o;return e=Math.min(t.selected[0],t.selected[1]),o=Math.max(t.selected[0],t.selected[1]),r.ajaxStart(),n.post("graph/delete",{from:e,to:o}).then(function(){return r.ajaxEnd(),t.distances=_.without(t.distances,_.findWhere(t.distances,{from:e,to:o})),t.selected=[]})},o=function(t,e){var n;return n=a(t,e),void 0===n?void 0:n.distance},a=function(e,n){var r,o;return r=Math.min(e,n),o=Math.max(e,n),_.find(t.distances,{from:r,to:o})}})}.call(this),function(){angular.module("Egerep").controller("LoginCtrl",function(t,e){var n;return n=function(){var e;return t.image_loaded=!1,e=new Image,e.addEventListener("load",function(){return $("body").css({"background-image":"url("+t.wallpaper.image_url+")"}),t.image_loaded=!0,t.$apply(),setTimeout(function(){return $("#center").removeClass("animated").removeClass("fadeIn").removeAttr("style")},2e3)}),e.src=t.wallpaper.image_url},angular.element(document).ready(function(){var e;if(n(),$('input[autocomplete="off"]').each(function(){var t,e;return e=this,t=$(e).attr("id"),$(e).removeAttr("id"),setTimeout(function(){return $(e).attr("id",t)},2e3)}),t.l=Ladda.create(document.querySelector("#login-submit")),t.logged_user&&(t.login=t.logged_user.email),e=$.cookie("login_data"),void 0!==e)return e=JSON.parse(e),t.login=e.login,t.password=e.password,t.sms_verification=!0,t.$apply()}),t.clearLogged=function(){return t.logged_user=null,t.login="",$.removeCookie("logged_user")},t.enter=function(e){if(13===e.keyCode)return t.checkFields()},t.goLogin=function(){if(!t.preview)return e.post("login",{login:t.login,password:t.password,code:t.code,captcha:grecaptcha.getResponse()}).then(function(e){return grecaptcha.reset(),e.data===!0?($.removeCookie("login_data"),location.reload()):"sms"===e.data?(t.in_process=!1,t.l.stop(),t.sms_verification=!0,$.cookie("login_data",JSON.stringify({login:t.login,password:t.password}),{expires:1/1440*2,path:"/"})):(t.in_process=!1,t.l.stop(),t.error="Неправильная пара логин-пароль"),t.$apply()})},t.checkFields=function(){if(!t.preview)return t.l.start(),t.in_process=!0,""===grecaptcha.getResponse()?grecaptcha.execute():t.goLogin()}})}.call(this),function(){angular.module("Egerep").controller("LogsIndex",function(t,e,n,r,o,a){var i;return bindArguments(e,arguments),t.frontend_loading=!0,e.$watch("search.table",function(t,n){if(t&&n||n&&!t)return e.search.column=null}),e.toJson=function(t){return JSON.parse(t)},e.refreshCounts=function(){return n(function(){return $(".selectpicker option").each(function(t,e){return $(e).data("subtext",$(e).attr("data-subtext")),$(e).data("content",$(e).attr("data-content"))}),$(".selectpicker").selectpicker("refresh")},100)},e.filter=function(){return $.cookie("logs",JSON.stringify(e.search),{expires:365,path:"/"}),e.current_page=1,e.pageChanged()},e.keyFilter=function(t){if(13===t.keyCode)return e.filter()},n(function(){return e.search=$.cookie("logs")?JSON.parse($.cookie("logs")):{},i(e.page),e.current_page=e.page}),e.pageChanged=function(){return t.frontend_loading=!0,i(e.current_page),paginate("logs",e.current_page)},i=function(n){var o;return o="?page="+n,r.get("api/logs"+o).then(function(n){return console.log(n),e.counts=n.data.counts,e.data=n.data.data,e.logs=n.data.data.data,t.frontend_loading=!1,e.refreshCounts()})}})}.call(this),function(){angular.module("Egerep").controller("NotificationsIndex",function(t,e,n,r,o,a,i,u){var s,c;return bindArguments(e,arguments),t.frontend_loading=!0,e.addDays=function(t,e){return moment(t).add({day:e})},e.pastDate=function(t){return!!(t&&Date.now()-new Date(t)>=0)},c=function(){return n(function(){return $(".selectpicker option").each(function(t,e){return $(e).data("subtext",$(e).attr("data-subtext")),$(e).data("content",$(e).attr("data-content"))}),$(".selectpicker").selectpicker("refresh")},100)},e.filter=function(){return $.cookie("notifications",JSON.stringify(e.search),{expires:365,path:"/"}),e.current_page=1,e.pageChanged()},e.changeState=function(n){return t.frontend_loading=!0,e.attachments=[],e.current_page=1,s(e.current_page),window.history.pushState(n,"","notifications/"+n.toLowerCase())},e.needsCall=function(t){var n;return"new"===a.getState(t)&&(n=moment().format("YYYY-MM-DD"),t.notification_id?0===t.notification_approved&&t.notification_date<=n:e.addDays(t.original_date,2).format("YYYY-MM-DD")<=n)},n(function(){return e.search=$.cookie("notifications")?JSON.parse($.cookie("notifications")):{},s(e.page),e.current_page=e.page}),e.pageChanged=function(){return t.frontend_loading=!0,t.attachments=[],s(e.current_page),paginate("notifications",e.current_page)},s=function(n){var o;return o="?page="+n,r.get("api/notifications/get"+o).then(function(n){return e.data=n.data.data,e.attachments=n.data.data.data,e.counts=n.data.counts,t.frontend_loading=!1,c()})}})}.call(this),function(){var t=[].indexOf||function(t){for(var e=0,n=this.length;e<n;e++)if(e in this&&this[e]===t)return e;return-1};angular.module("Egerep").controller("PaymentsIndex",function(e,n,r,o,a,i,u,s){var c;return bindArguments(e,arguments),$(window).on("keydown",function(t){if(8===t.which)return e.removeSelectedPayments()}),$("#import-button").fileupload({start:function(){return ajaxStart()},always:function(){return ajaxEnd()},done:function(t,n){return notifySuccess("<b>"+n.result+"</b> импортировано"),e.filter()},error:function(t){return console.log(t),notifyError(t.responseJSON)}}),angular.element(document).ready(function(){return r(function(){return $(".selectpicker").selectpicker("refresh")},1e3),e.search=$.cookie("payments")?JSON.parse($.cookie("payments")):{addressee_id:"",source_id:"",expenditure_id:"",type:""},e.selected_payments=[],e.tab="payments",a.init(i,e.current_page,n)}),e.filter=function(){return $.cookie("payments",JSON.stringify(e.search),{expires:365,path:"/"}),a.current_page=1,a.pageChanged()},e.keyFilter=function(t){if(13===t.keyCode)return e.filter()},e.selectPayment=function(n){var r;return r=n.id,t.call(e.selected_payments,r)>=0?e.selected_payments=_.without(e.selected_payments,n.id):e.selected_payments.push(n.id)},e.removeSelectedPayments=function(){if(e.selected_payments.length)return bootbox.confirm("Вы уверены, что хотите удалить <b>"+e.selected_payments.length+"</b> платежей?",function(t){if(t===!0)return ajaxStart(),$.post("api/payments/delete",{ids:e.selected_payments}).then(function(t){return e.selected_payments=[],e.filter(),ajaxEnd()})})},e.getExpenditure=function(t){var n;return t=parseInt(t),n=null,e.expenditures.forEach(function(e){if(!n)return e.data.forEach(function(e){e.id===t&&(n=e)})}),n},e.addPaymentDialog=function(t){return null==t&&(t=!1),e.modal_payment=_.clone(t||e.fresh_payment),$("#payment-stream-modal").modal("show")},e.savePayment=function(){var t;return e.adding_payment=!0,e.modal_payment.date?e.modal_payment.source_id?e.modal_payment.addressee_id?e.modal_payment.expenditure_id?e.modal_payment.purpose?(t=e.modal_payment.id?i.update:i.save)(e.modal_payment,function(t){return e.adding_payment=!1,$("#payment-stream-modal").modal("hide"),e.filter()}):($("#payment-purpose").focus(),void notifyError("укажите назначение")):void notifyError("укажите статью"):void notifyError("укажите адресат"):void notifyError("укажите источник"):($("#payment-date").focus(),void notifyError("укажите дату"))},e.clonePayment=function(t){var n;return n=_.clone(t),delete n.id,delete n.created_at,delete n.updated_at,delete n.user_id,e.addPaymentDialog(n)},e.deletePayment=function(){return i["delete"]({id:e.modal_payment.id},function(t){return $("#payment-stream-modal").modal("hide"),e.filter()})},e.editPayment=function(t){return e.modal_payment=_.clone(t),$("#payment-stream-modal").modal("show")},e.formatStatDate=function(t){return moment(t+"-01").format("MMMM")},e.loadStats=function(){if("stats"===e.tab)return e.stats_loading=!0,ajaxStart(),o.post("api/payments/stats",e.search_stats).then(function(t){return ajaxEnd(),e.stats_loading=!1,t.data?(e.stats_data=t.data.data,e.expenditure_data=t.data.expenditures,r(function(){return e.totals=c()})):e.stats_data=null})},c=function(){var t;return t={"in":0,out:0,sum:0},$.each(e.stats_data,function(e,n){return t["in"]+=parseFloat(n["in"]),t.out+=parseFloat(n.out),t.sum+=parseFloat(n.sum)}),t}}).controller("PaymentForm",function(t,e,n){return bindArguments(t,arguments),angular.element(document).ready(function(){return e.init(n,t.id,t.model),e.prefix=""})}).controller("PaymentSourceIndex",function(t,e,n,r,o){return bindArguments(t,arguments),angular.element(document).ready(function(){return r.init(o,t.current_page,e)}),t.sortableOptions={cursor:"move",opacity:.9,zIndex:9999,tolerance:"pointer",axis:"y",containment:"parent",update:function(t,e){return n(function(){return r.page.data.forEach(function(t,e){return o.update({id:t.id,position:e})})})}}}).controller("PaymentSourceForm",function(t,e,n,r){return bindArguments(t,arguments),angular.element(document).ready(function(){return e.init(n,t.id,t.model),e.prefix="payments/"}),t.editRemainder=function(e){return t.modal_remainder=_.clone(e),$("#remainder-stream-modal").modal("show")},t.deleteRemainder=function(o){return r["delete"]({id:o.id},function(r){return $("#remainder-stream-modal").modal("hide"),e.init(n,t.id,t.model)})},t.addRemainderDialog=function(e){return null==e&&(e=!1),t.modal_remainder=_.clone(e||{date:moment().format("DD.MM.YYYY"),source_id:t.id}),$("#remainder-stream-modal").modal("show")},t.saveRemainder=function(){var o;return t.adding_remainder=!0,(o=t.modal_remainder.id?r.update:r.save)(t.modal_remainder,function(r){return t.adding_remainder=!1,$("#remainder-stream-modal").modal("hide"),e.init(n,t.id,t.model)})}}).controller("PaymentExpenditureIndex",function(t,e,n,r,o,a){return bindArguments(t,arguments),angular.element(document).ready(function(){return t.groups=a.query()}),t.onEdit=function(t,e){return a.update({id:t,name:$(e.target).text()})},t.removeGroup=function(e){return bootbox.confirm("Вы уверены, что хотите удалить группу «"+e.name+"»",function(n){if(n===!0)return a.remove({id:e.id},function(){return t.groups=a.query()})})},t.sortableOptions={cursor:"move",opacity:.9,zIndex:9999,tolerance:"pointer",axis:"y",containment:"parent",update:function(e,r,a){return n(function(){return t.groups.forEach(function(t){return t.data.forEach(function(t,e){return o.update({id:t.id,position:e})})})})}},t.sortableGroupOptions={cursor:"move",opacity:.9,zIndex:9999,tolerance:"pointer",axis:"y",containment:"parent",items:".item-draggable",update:function(e,r,o){return n(function(){return t.groups.forEach(function(t,e){return a.update({id:t.id,position:e})})})}}}).controller("PaymentExpenditureForm",function(t,e,n,r,o){return bindArguments(t,arguments),angular.element(document).ready(function(){return n.init(r,t.id,t.model),n.prefix="payments/"}),t.changeGroup=function(){if(n.model.group_id===-1)return n.model.group_id="",$("#new-group").modal("show")},t.createNewGroup=function(){return $("#new-group").modal("hide"),o.save({name:t.new_group_name},function(r){return t.new_group_name="",t.groups.push(r),n.model.group_id=r.id,e(function(){return $(".selectpicker").selectpicker("refresh")})})}}).controller("PaymentRemainders",function(t,e,n){var r;return bindArguments(t,arguments),angular.element(document).ready(function(){}),t.filterChanged=function(){return t.current_page=1,r(1)},t.pageChanged=function(){return r(t.current_page),paginate("payments/remainders",t.current_page)},t.getDatesReversed=function(){var e;if(t.data)return e=[],$.each(t.data.items,function(t){return e.push(t)}),e.sort().reverse()},r=function(n){return ajaxStart(),e.post("api/payments/remainders",{page:n,source_id:t.source_id}).then(function(e){return ajaxEnd(),t.data=e.data})}})}.call(this),function(){angular.module("Egerep").controller("PeriodsIndex",function(t,e,n,r,o,a,i,u,s,c,d,l,f){var m,p,g;return bindArguments(t,arguments),n.frontend_loading=!0,t.search={},e(function(){return g(t.page),t.current_page=t.page}),p=function(){var e;return e="total"===t.type?"":"/"+t.type},m=function(t){return t.indexOf("/")!==-1?(t=t.split("/")[1],t?parseInt(t):0):Math.round(.25*parseInt(t))},t.recalcErrors=function(){return t.account_errors_updating=!0,r.post("api/command/model-errors",{model:"accounts"})},t.totalCommission=function(t){var e;return e=0,$.each(t.data,function(t,n){return $.each(n,function(t,n){if(""!==n)return e+=m(n)})}),e},t.pageChanged=function(){return ajaxStart(),n.frontend_loading=!0,g(t.current_page),paginate("periods"+p(),t.current_page)},t.filter=t.pageChanged,t.getSum=function(t){var e,n;return n=0,e=0,t.forEach(function(t){return t.id?n+=t.sum:e+=t.sum}),[n,e]},g=function(o){var a;return a=p(),a+="?page="+o,$.each(t.search,function(t,e){return a+="&"+t+"="+e,console.log(t,e)}),r.get("api/periods"+a).then(function(r){return ajaxEnd(),n.frontendStop(),t.data=r.data,t.periods=t.data.data,e(function(){return $(".selectpicker").selectpicker("refresh")},200)})},t.toggleConfirmed=function(t,e){return n.toggleEnumServer(t,"confirmed",s,e)}})}.call(this),function(){angular.module("Egerep").controller("RequestsIndex",function(t,e,n,r,o,a,i,u,s,c,d,l,f){var m,p;return bindArguments(e,arguments),_.extend(a,{all_denies:"отказы",all:"все"}),t.frontend_loading=!0,n(function(){return e.user_id=e.errors?"":localStorage.getItem("requests_index_user_id")}),l.bind("RequestUserChanged",function(t){var n;if(n=findById(e.requests,t.request_id))return n.user_id=t.new_user_id,e.$apply()}),e.recalcErrors=function(){return e.request_errors_updating=!0,r.post("api/command/model-errors",{model:"requests"})},e.howLongAgo=function(t){var e,n,r,o;return o=moment(Date.now()),t=moment(new Date(t).getTime()),console.log(t),e=o.diff(t,"days"),n=o.diff(t,"hours")-24*e,r=o.diff(t,"minutes")-60*n-24*e,{days:e,hours:n+24*e,minutes:r}},e.changeList=function(n){if(e.chosen_state_id=n,e.current_page=1,t.loaded_comments=0,t.frontend_loading=!0,ajaxStart(),p(1),ajaxEnd(),!e.errors)return window.history.pushState("requests/"+n.toLowerCase(),"","requests/"+n.toLowerCase())},m=function(){return e.RequestStatesForTabLabel=angular.copy(e.RequestStates),_.extend(e.RequestStatesForTabLabel,{all:"все"})},n(function(){return m(),p(e.page),e.current_page=e.page}),e.pageChanged=function(){return t.frontend_loading=!0,t.loaded_comments=0,p(e.current_page),paginate("requests/"+e.chosen_state_id,e.current_page)},p=function(o){var a;return e.chosen_state_id||(e.chosen_state_id="all"),a="?page="+o,a+="&state="+e.chosen_state_id,""!==e.user_id&&(a+="&user_id="+e.user_id),e.error&&(a+="&error="+e.error),r.get("api/requests"+a).then(function(n){return e.data=n.data,e.requests=e.data.data,e.requests.forEach(function(t){return t.client.markers.forEach(function(t){return t.metros=_.sortBy(t.metros,function(t){return t.minutes})})}),t.frontend_loading=!1}),r.post("api/requests/counts",{state:e.chosen_state_id,user_id:e.user_id,error:e.error}).then(function(t){return e.request_state_counts=t.data.request_state_counts,e.user_counts=t.data.user_counts,e.error_counts=t.data.error_counts,console.log("counts updated"),n(function(){return $("#change-state option, #change-user option, #error-counts option").each(function(t,e){return $(e).data("subtext",$(e).attr("data-subtext")),$(e).data("content",$(e).attr("data-content"))}),$("#change-state, #change-user, #error-counts").selectpicker("refresh")})})},e.hasBannedUsers=function(){return _.filter(s.getBannedUsers(),function(t){return e.user_counts&&void 0!==e.user_counts[t.id]&&e.user_counts[t.id]>0}).length},e.changeState=function(){return localStorage.setItem("requests_index_state",e.state),e.changeList(e.state)},e.changeUser=function(){return localStorage.setItem("requests_index_user_id",e.user_id),e.changeList(e.chosen_state_id)},e.toggleState=function(n){var r;return r=angular.copy(n),t.toggleEnum(r,"state",a),e.Request.update({id:r.id,state:r.state},function(e){return t.toggleEnum(n,"state",a)})}}).controller("RequestsForm",function(t){return console.log("here")})}.call(this),function(){angular.module("Egerep").controller("ReviewsIndex",function(t,e,n,r,o,a,i,u,s,c){var d,l;return bindArguments(e,arguments),t.frontend_loading=!0,e.recalcReviewErrors=function(){return e.review_errors_updating=!0,r.post("api/command/model-errors",{model:"reviews"})},l=function(){return n(function(){return $(".selectpicker option").each(function(t,e){return $(e).data("subtext",$(e).attr("data-subtext")),$(e).data("content",$(e).attr("data-content"))}),$(".selectpicker").selectpicker("refresh")},100)},e.filter=function(){return $.cookie("reviews",JSON.stringify(e.search),{expires:365,path:"/"}),e.current_page=1,e.pageChanged()},n(function(){return e.search=$.cookie("reviews")?JSON.parse($.cookie("reviews")):{},
d(e.page),e.current_page=e.page}),e.pageChanged=function(){return t.frontend_loading=!0,d(e.current_page),paginate("reviews",e.current_page)},d=function(n){var o;return o="?page="+n,r.get("api/reviews"+o).then(function(n){return console.log(n),e.counts=n.data.counts,e.data=n.data.data,e.attachments=n.data.data.data,t.frontend_loading=!1,l()})}}).controller("TutorReviews",function(t,e,n,r,o,a,i,u,s,c){var d,l;return bindArguments(e,arguments),t.frontend_loading=!0,e.recalcReviewErrors=function(){return e.review_errors_updating=!0,r.post("api/command/model-errors",{model:"reviews"})},l=function(){return n(function(){return $(".selectpicker option").each(function(t,e){return $(e).data("subtext",$(e).attr("data-subtext")),$(e).data("content",$(e).attr("data-content"))}),$(".selectpicker").selectpicker("refresh")},100)},e.filter=function(){return $.cookie("tutor_reviews",JSON.stringify(e.search),{path:"/"}),e.current_page=1,e.pageChanged()},e.pageChanged=function(){return t.frontend_loading=!0,d(e.current_page),paginate("reviews/"+e.tutor_id,e.current_page)},d=function(n){var o;return o="?page="+n+"&tutor_id="+e.tutor_id,r.get("api/reviews"+o).then(function(n){return e.counts=n.data.counts,e.data=n.data.data,e.attachments=n.data.data.data,t.frontend_loading=!1,l()})},angular.element(document).ready(function(){return e.search={tutor_id:e.tutor_id},$.cookie("tutor_reviews",JSON.stringify(e.search),{path:"/"}),d(e.page),e.current_page=e.page})})}.call(this),function(){Vue.config.devtools=!0,$(document).ready(function(){var t;return $("#searchModalOpen").click(function(){var t;return $("#searchModal").modal({keyboard:!0}),t=function(){return $("#searchQueryInput").focus()},setTimeout(t,500),$($("body.modal-open .row")[0]).addClass("blur"),!1}),$("#searchModal").on("hidden.bs.modal",function(){var t;return t=function(){return $(".blur").removeClass("blur")},setTimeout(t,500)}),t=new Vue({el:"#searchModal",data:{lists:[],links:{},results:-1,active:0,query:"",oldquery:"",all:0,loading:!1},methods:{loadData:_.debounce(function(){return this.$http.post("api/search",{query:this.query}).then(function(t){return function(e){var n,r,o,a,i,u,s,c,d;if(t.loading=!1,t.active=0,t.all=0,t.lists=[],!(e.body.results>0))return t.active=0,t.all=0,t.lists=[],t.results=0;if(t.results=e.body.results,e.body.clients.length>0)for(s=e.body.clients,n=o=0,i=s.length;o<i;n=++o)r=s[n],r.type="clients",t.all++,t.links[t.all]="client/"+r.id,r.link=t.links[t.all],t.lists.push(r);if(e.body.tutors.length>0){for(c=e.body.tutors,d=[],n=a=0,u=c.length;a<u;n=++a)r=c[n],r.type="tutors",t.all++,t.links[t.all]="tutors/"+r.id+"/edit",r.link=t.links[t.all],d.push(t.lists.push(r));return d}}}(this),function(t){return function(e){return t.active=0,t.all=0,t.lists=[],t.results=0}}(this))},150),scroll:function(){return $("#searchResult").scrollTop(30*(this.active-4))},getStateClass:function(t){var e;return e={},e["tutor-state-"+t]=!0,e},keyup:function(t){var e;return"ArrowUp"===t.code?(t.preventDefault(),this.active>0&&this.active--,this.scroll()):"ArrowDown"===t.code?(t.preventDefault(),this.active<this.results&&this.active++,this.active>4&&this.scroll()):"Enter"===t.code&&this.active>0?(e=this.links[this.active],0===e.indexOf("tutors")?window.open(e,"_blank"):window.location=e):""!==this.query?(this.oldquery!==this.query&&this.query.length>2&&this.loadData(),this.oldquery=this.query):(this.active=0,this.all=0,this.lists=[],this.results=-1),null}}})})}.call(this),function(){angular.module("Egerep").controller("SmsIndex",function(t,e,n,r){return bindArguments(t,arguments),e.frontend_loading=!0,t.pageChanged=function(){return t.filter(t.current_page),paginate("sms",t.current_page)},t.filter=function(n){var o;return null==n&&(n=null),e.frontend_loading=!0,o={page:n||t.current_page,search:t.search,is_secret:t.is_secret},r.get("api/sms/list?"+$.param(o)).then(function(n){return e.frontendStop(),t.data=n.data,t.sms=t.data.data})},n(function(){return t.filter(t.page),t.current_page=t.page})})}.call(this),function(){angular.module("Egerep").controller("StreamIndex",function(t,e,n,r,o){var a,i;return bindArguments(e,arguments),t.frontend_loading=!0,i=function(){return n(function(){return $(".selectpicker option").each(function(t,e){return $(e).data("subtext",$(e).attr("data-subtext")),$(e).data("content",$(e).attr("data-content"))}),$(".selectpicker").selectpicker("refresh")},100)},e.keyFilter=function(t){if(13===t.keyCode)return e.filter()},e.filter=function(){return $.cookie("stream",JSON.stringify(e.search),{expires:365,path:"/"}),e.current_page=1,e.pageChanged()},n(function(){return e.search=$.cookie("stream")?JSON.parse($.cookie("stream")):{},a(e.page),e.current_page=e.page}),e.pageChanged=function(){return t.frontend_loading=!0,a(e.current_page),paginate("stream",e.current_page)},a=function(n){var o;return o="?page="+n,r.get("api/stream"+o).then(function(n){return console.log(n),e.counts=n.data.counts,e.data=n.data.data,e.stream=n.data.data.data,t.frontend_loading=!1,i()})}}).controller("StreamConfigurations",function(t,e,n,r,o){})}.call(this),function(){angular.module("Egerep").controller("SummaryUsers",function(t,e,n,r,o,a,i){return bindArguments(t,arguments),n(function(){return t.search={},t.allowed_all||(t.search.user_ids=[t.user.id.toString()]),t.search.type||(t.search.type="months"),n(function(){return $("#change-user, #change-type").selectpicker("refresh")})},500),t.updateEfficency=function(){return t.efficency_updating=!0,r.post("api/command/recalc-efficency")},t.update=function(){return e.frontend_loading=!0,r.post("api/summary/users",t.search).then(function(n){return e.frontend_loading=!1,t.stats=n.data},function(n){return e.frontend_loading=!1,t.stats=null})},t.getExplanation=function(){return e.explaination_loading=!0,r.post("api/summary/users/explain",t.search).then(function(n){return e.explaination_loading=!1,t.stats.efficency=n.data})},t.explaination_tutors_loading=!1,t.getExplanationByTutors=function(){return t.explaination_tutors_loading=!0,r.post("api/summary/users/explain/tutors",t.search).then(function(e){return t.explaination_tutors_loading=!1,t.explanation_tutors=e.data})},t.monthYear=function(t){return moment(t).format("MMMM YYYY")},t.sumEfficency=function(){var e;return e=_.reduce(t.stats.efficency,function(t,e){return _.each(e.attachments,function(e){return t+=e.rate}),t},0),e.toFixed(2)},t.sumShare=function(){var e;return e=_.reduce(t.stats.efficency,function(e,n){return n.attachments.length&&_.each(n.attachments,function(t){return e+=t.share}),t.isDenied(n)&&(e+=1),e},0),e.toFixed(2)},t.isDenied=function(t){var e;return"deny"===(e=t.state)}}).controller("SummaryIndex",function(t,e,n,r,o){var a,i;return bindArguments(e,arguments),t.frontend_loading=!0,e.debt_updating=!1,e.updateDebt=function(){return e.debt_updating=!0,n.post("api/command/recalc-debt").then(function(t){return e.debt_updating=!1,e.debt_updated=t.data.debt_updated,e.debt_sum=t.data.debt_sum})},r(function(){return i(e.page),e.current_page=e.page}),a=function(){var t;return t="total"===e.type?"":"/"+e.type},e.pageChanged=function(){return ajaxStart(),i(e.current_page),paginate("summary"+a()+"/"+e.filter,e.current_page)},e.updateDebt=function(){return e.debt_updating=1,n.post("api/command/recalc-debt")},i=function(r){var o;return o=a(),o+="?page="+r,o+="&filter="+e.filter,n.post("api/summary"+o).then(function(n){return ajaxEnd(),t.frontendStop(),e.summaries=n.data})}})}.call(this),function(){angular.module("Egerep").controller("TemplateIndex",function(t,e,n,r){return e.form_changed=!1,e.save=function(){return n.post("templates",{allTemplates:e.allTemplates}).then(function(t){return e.form_changed=!1},function(t){return console.error(t),e.form_changed=!1})},angular.element(document).ready(function(){return $(".checkChange").on("keyup change","input, select, textarea",function(){return e.form_changed=!0,e.$apply()})})})}.call(this),function(){var t=[].indexOf||function(t){for(var e=0,n=this.length;e<n;e++)if(e in this&&this[e]===t)return e;return-1};angular.module("Egerep").controller("TutorsSelect",function(e,n,r,o,a,i,u,s,c,d,l){var f,m,p,g,h,v,y,b;return bindArguments(e,arguments),f=.3,p=0,g=void 0,e.mode="map",e.loading=!1,e.tutors=[],e.list_tutor_ids=[],angular.element(document).ready(function(){return e.list=new c(e.list),$(".map-tutor-list").droppable()}),e.blurComment=function(t){return t.is_being_commented=!1,t.ready_to_work=t.old_ready_to_work},e.focusComment=function(t){return t.is_being_commented=!0,t.old_ready_to_work=t.ready_to_work},e.startComment=function(t){return t.is_being_commented=!0,t.old_ready_to_work=t.ready_to_work,$timeout(function(){return $("#list-comment-"+t.id).focus()})},e.saveComment=function(t,e){if(13===t.keyCode)return l.update({id:e.id,ready_to_work:e.ready_to_work},function(n){return e.old_ready_to_work=e.ready_to_work,$(t.target).blur()})},e.getHours=function(t){return Math.floor(t/60)},e.getMinutes=function(t){return t%60},e.find=function(){return e.loading=!0,u.select({search:e.search}).then(function(t){return e.tutors=t.data,y(),v(),e.loading=!1})},e.added=function(n){return t.call(e.list_tutor_ids.map(Number),n)>=0},h=function(){return $(".temporary-tutor").draggable({containment:"window",revert:function(t){return!!t||(e.tutor_list=removeById(e.tutor_list,e.dragging_tutor.id),e.$apply())}})},e.startDragging=function(t){return e.dragging_tutor=t},y=function(){return b(),e.marker_id=1,e.tutor_list=[],e.markers=[],e.tutors.forEach(function(t){if(void 0!==t.markers)return t.markers.forEach(function(n){var r;return r=newMarker(e.marker_id++,new google.maps.LatLng(n.lat,n.lng),e.map,n.type),r.metros=n.metros,r.tutor=t,r.setMap(e.map),m(r),e.markers.push(r)})}),g=new MarkerClusterer(e.map,e.markers,{gridSize:10,imagePath:"img/maps/clusterer/m"})},b=function(){if(void 0!==e.markers&&e.markers.forEach(function(t){return t.setMap(null)}),void 0!==g)return g.clearMarkers()},m=function(n){return google.maps.event.addListener(n,"click",function(r){if(p++,1===p)return setTimeout(function(){var r;return 1===p?(r=n.tutor,t.call(e.tutor_list,r)>=0?e.tutor_list=removeById(e.tutor_list,n.tutor.id):(e.hovered_tutor=null,e.tutor_list.push(n.tutor)),e.$apply(),h()):e.addOrRemove(n.tutor.id),p=0},250)}),google.maps.event.addListener(n,"dblclick",function(t){return p++}),google.maps.event.addListener(n,"mouseover",function(r){var o;if(o=n.tutor,!(t.call(e.tutor_list,o)>=0))return e.hovered_tutor=n.tutor,e.$apply()}),google.maps.event.addListener(n,"mouseout",function(t){return e.hovered_tutor=null,e.$apply()})},e.addOrRemove=function(n){return n=parseInt(n),t.call(e.list_tutor_ids.map(Number),n)>=0?e.list_tutor_ids=_.without(e.list_tutor_ids.map(Number),n):e.list_tutor_ids.push(n),v(),e.list.$update()},v=function(){return e.markers.forEach(function(n){var r,o;if(r=n.tutor.id,t.call(e.list_tutor_ids.map(Number),r)>=0&&!n.chosen&&(n.chosen=!0,n.setOpacity(1),n.setIcon(ICON_BLUE)),o=n.tutor.id,t.call(e.list_tutor_ids.map(Number),o)<0&&n.chosen)return n.chosen=!1,n.setIcon(getMarkerType(n.type))})},e.$on("mapInitialized",function(t,n){var r;return e.gmap=n,r={lat:55.7387,lng:37.6032},e.RECOM_BOUNDS=new google.maps.LatLngBounds(new google.maps.LatLng(r.lat-.5,r.lng-.5),new google.maps.LatLng(r.lat+.5,r.lng+.5)),e.geocoder=new google.maps.Geocoder,e.gmap.setCenter(new google.maps.LatLng(55.7387,37.6032)),e.gmap.setZoom(11)})})}.call(this),function(){angular.module("Egerep").controller("TutorsIndex",function(t,e,n,r,o,a,i,u,s,c,d){var l;return bindArguments(t,arguments),e.frontend_loading=!0,t.recalcTutorErrors=function(){return t.tutor_errors_updating=!0,r.post("api/command/model-errors",{model:"tutors"})},t.state=localStorage.getItem("tutors_index_state"),t.user_id=localStorage.getItem("tutors_index_user_id"),t.published_state=localStorage.getItem("tutors_index_published_state"),t.errors_state=localStorage.getItem("tutors_index_errors_state"),t.egecentr_source=localStorage.getItem("tutors_index_egecentr_source"),t.markers_state=localStorage.getItem("tutors_index_markers_state"),u.bind("ResponsibleUserChanged",function(e){var n;if(n=findById(t.tutors,e.tutor_id))return n.responsible_user_id=e.responsible_user_id,t.$apply()}),t.duplicateClick=function(e){return t.global_search=e,n(function(){return $("#global-search").submit()})},t.yearDifference=function(t){return moment().format("YYYY")-t},t.changeState=function(){return localStorage.setItem("tutors_index_state",t.state),l(t.current_page)},t.changeUser=function(){return localStorage.setItem("tutors_index_user_id",t.user_id),l(t.current_page)},t.changePublishedSate=function(){return localStorage.setItem("tutors_index_published_state",t.published_state),l(t.current_page)},t.changeErrorsState=function(){return localStorage.setItem("tutors_index_errors_state",t.errors_state),l(t.current_page)},t.changeSource=function(){return localStorage.setItem("tutors_index_egecentr_source",t.egecentr_source),l(t.current_page)},t.changeMarkers=function(){return localStorage.setItem("tutors_index_markers_state",t.markers_state),l(t.current_page)},n(function(){return l(t.page),t.current_page=t.page}),t.pageChanged=function(){return l(t.current_page),paginate("tutors",t.current_page)},l=function(o){var a;return e.frontend_loading=!0,a="?page="+o,t.global_search&&(a+="&global_search="+t.global_search),null!==t.state&&""!==t.state&&(a+="&state="+t.state),t.user_id&&(a+="&user_id="+t.user_id),null!==t.published_state&&""!==t.published_state&&(a+="&published_state="+t.published_state),null!==t.errors_state&&""!==t.errors_state&&(a+="&errors_state="+t.errors_state),null!==t.egecentr_source&&""!==t.egecentr_source&&(a+="&egecentr_source="+t.egecentr_source),null!==t.markers_state&&""!==t.markers_state&&(a+="&markers_state="+t.markers_state),r.get("api/tutors"+a).then(function(n){return e.frontendStop(),t.data=n.data,t.tutors=t.data.data}),r.post("api/tutors/counts",{state:t.state,user_id:t.user_id,published_state:t.published_state,errors_state:t.errors_state,egecentr_source:t.egecentr_source,markers_state:t.markers_state}).then(function(r){return t.state_counts=r.data.state_counts,t.user_counts=r.data.user_counts,t.published_counts=r.data.published_counts,t.errors_counts=r.data.errors_counts,t.source_counts=r.data.source_counts,t.marker_counts=r.data.marker_counts,n(function(){return $("#change-state option, #change-user option, #change-published option, #change-errors option, #change-source option, #change-markers option").each(function(t,e){return $(e).data("subtext",$(e).attr("data-subtext")),$(e).data("content",$(e).attr("data-content"))}),$("#change-state, #change-user, #change-published, #change-errors, #change-source, #change-markers").selectpicker("refresh"),e.frontend_loading=!1})})},t.blurComment=function(t){return t.is_being_commented=!1,t.list_comment=t.old_list_comment},t.focusComment=function(t){return t.is_being_commented=!0,t.old_list_comment=t.list_comment},t.startComment=function(t){return t.is_being_commented=!0,t.old_list_comment=t.list_comment,n(function(){return $("#list-comment-"+t.id).focus()})},t.saveComment=function(t,e){if(13===t.keyCode)return o.update({id:e.id,list_comment:e.list_comment},function(n){return e.old_list_comment=e.list_comment,$(t.target).blur()})}}).controller("TutorsForm",function(t,e,n,r,o,a,i,u,s,c,d,l,f,m,p,g){var h,v,y;return bindArguments(t,arguments),e.frontend_loading=!0,t.form_changed=!1,t.fully_loaded=!1,t.mergeTutor=function(){return $("#merge-tutor").modal("show")},t.mergeTutorGo=function(){return $("#merge-tutor").modal("hide"),p.post("api/tutors/merge",{tutor_id:t.tutor.id,new_tutor_id:t.new_tutor_id}).then(function(t){return"false"===t.data?bootbox.alert("Существуют задублированные клиенты"):bootbox.alert("Информация перенесена")})},t.deleteTutor=function(){return bootbox.confirm("Вы уверены, что хотите удалить преподавателя?",function(e){if(e===!0)return ajaxStart(),t.tutor.$delete(function(){return history.back()})})},t.shortenGrades=function(){var e,r,o,a,u,s,c;if(e=t.tutor.grades,!(e.length<1)){for(s=e.length-1,r=-1,c=[],a=0;a<=s;)if(o=parseInt(e[a]),o>11)a++,r=-1,c.push(i[o]);else if(o<=r)a++;else{for(u=a;u<=s&&(r=parseInt(e[u]),!(r>=11))&&!(parseInt(e[u+1])-r>1);)u++;o!==r?c.push(o+"–"+r+" классы"):c.push(o+" класс"),a++}n(function(){return $("#sp-tutor-grades").parent().find(".filter-option").html(c.join(", "))})}},t.deletePhoto=function(){return bootbox.confirm("Удалить фото преподавателя?",function(e){if(e===!0)return t.tutor.$deletePhoto(function(){return t.tutor.has_photo_cropped=!1,t.tutor.has_photo_original=!1})})},t.saveCropped=function(){return $("#photo-edit").cropper("getCroppedCanvas").toBlob(function(e){var n;return n=new FormData,n.append("croppedImage",e),n.append("tutor_id",t.tutor.id),ajaxStart(),$.ajax("upload/cropped",{method:"POST",data:n,processData:!1,contentType:!1,dataType:"json",success:function(e){return ajaxEnd(),t.tutor.has_photo_cropped=!0,t.photo_cropped_size=e,t.picture_version++,t.$apply(),t.closeDialog("change-photo")}})})},h=function(){return $("#photo-edit").cropper("destroy"),$("#photo-edit").cropper({aspectRatio:.8,preview:".img-preview",viewMode:1,zoomable:!1,zoomOnWheel:!1,crop:function(e){var n,r;return r=$("#photo-edit").cropper("getCroppedCanvas").width,n=Math.round(r/240*100),t.quality=n>100?100:n,t.$apply()},built:function(){return t.cropper_built=!0,t.$apply()}})},t.picture_version=1,v=function(){return $("#fileupload").fileupload({formData:{tutor_id:t.tutor.id},maxFileSize:1e7,send:function(){return NProgress.configure({showSpinner:!0})},progress:function(t,e){return NProgress.set(e.loaded/e.total)},always:function(){return NProgress.configure({showSpinner:!1}),ajaxEnd()},done:function(e,n){return t.tutor.photo_extension=n.result.extension,t.tutor.photo_original_size=n.result.size,t.tutor.photo_cropped_size=0,t.tutor.has_photo_original=!0,t.tutor.has_photo_cropped=!1,t.picture_version++,t.$apply(),h()}})},t.showPhotoEditor=function(){return t.dialog("change-photo"),t.cropper_built=!1,h()},n(function(){return t.id>0?t.tutor=r.get({id:t.id},function(){return n(function(){return v()},1e3),t.original_tutor=angular.copy(t.tutor),e.frontendStop()}):(t.tutor=m.default_tutor,e.frontendStop())}),t.$watch("tutor.subjects",function(t,e){if(void 0!==t)return void 0===e&&sp("tutor-subjects","предмет","+"),void 0!==e?spRefresh("tutor-subjects"):void 0}),t.$watch("tutor.subjects_ec",function(t,e){if(void 0!==t)return void 0===e&&sp("tutor-subjects-ec","предмет","+"),void 0!==e?spRefresh("tutor-subjects-ec"):void 0}),t.$watch("tutor.grades",function(e,r){if(void 0!==e)return void 0===r?(sp("tutor-grades","классы"),n(function(){return t.shortenGrades()},50)):n(function(){return t.shortenGrades()})}),t.$watch("tutor.branches",function(t,e){if(void 0!==t)return void 0===e&&sp("tutor-branches","филиалы"," "),void 0!==e?spRefresh("tutor-branches"):void 0}),t.$watchCollection("tutor",function(e,n){if(t.fully_loaded)return t.form_changed=!0}),t.svgSave=function(){t.form_changed=!0,$("#svg-modal").modal("hide")},t.yearDifference=function(t){return moment().format("YYYY")-t},t.getAge=function(t){if(t)return moment().format("YYYY")-t.split(".")[2]},t.add=function(){return t.saving=!0,r.save(t.tutor,function(t){return window.location="tutors/"+t.id+"/edit"})},t.edit=function(){return ajaxStart(),t.saving=!0,y(),t.tutor.$update().then(function(e){return t.tutor=e,t.loadMarkers(),t.saving=!1,t.form_changed=!1,ajaxEnd()})},t.marker_id=1,y=function(){var e;return e=[],$.each(t.tutor.markers,function(t,n){return e.push(_.pick(n,"lat","lng","type","metros","server_id","comment"))}),t.tutor.markers=e},t.$on("mapInitialized",function(e,n){var r;return t.gmap=n,t.loadMarkers(),r={lat:55.7387,lng:37.6032},t.RECOM_BOUNDS=new google.maps.LatLngBounds(new google.maps.LatLng(r.lat-.5,r.lng-.5),new google.maps.LatLng(r.lat+.5,r.lng+.5)),t.geocoder=new google.maps.Geocoder,google.maps.event.addListener(n,"click",function(e){return t.gmapAddMarker(e)})}),t.showMap=function(){var e,n;if($("#gmap-modal").modal("show"),google.maps.event.trigger(t.gmap,"resize"),t.gmap.setCenter(new google.maps.LatLng(55.7387,37.6032)),t.gmap.setZoom(11),$("#map-search").val(""),t.search_markers&&t.search_markers.length&&($.each(t.search_markers,function(t,e){return e.setMap(null)}),t.search_markers=[]),t.tutor.markers.length&&(e=new google.maps.LatLngBounds,n=0,$.each(t.tutor.markers,function(t,r){return n++,e.extend(r.position)}),n>0))return t.gmap.fitBounds(e),t.gmap.panToBounds(e),t.gmap.setZoom(11)},t.gmapAddMarker=function(e){var n;return n=newMarker(t.marker_id++,e.latLng,t.map),t.tutor.markers.push(n),n.setMap(t.gmap),u.metro("closest",{lat:n.lat,lng:n.lng}).then(function(t){return n.metros=t.data}),t.bindMarkerDelete(n),t.bindMarkerChangeType(n)},t.bindMarkerDelete=function(e){return google.maps.event.addListener(e,"dblclick",function(e){var n;return n=this,n.setMap(null),$.each(t.tutor.markers,function(e,r){if(console.log("id",n.id,r.id),void 0!==r&&n.id===r.id)return void 0!==r.server_id?g["delete"]({id:r.server_id},function(){return t.tutor.markers.splice(e,1)}):t.tutor.markers.splice(e,1)})})},t.bindMarkerChangeType=function(t){return google.maps.event.addListener(t,"click",function(e){var n,r;return"green"===this.type?(this.type="red",r=ICON_RED):(this.type="green",r=ICON_GREEN),n=this,void 0!==t.server_id?g.update({id:t.server_id,type:this.type},function(){return n.setIcon(r)}):n.setIcon(r)})},t.searchMap=function(e){return t.geocoder.geocode({address:e+", московская область",bounds:t.RECOM_BOUNDS,componentRestrictions:{country:"RU",administrativeArea:"Moscow"}},function(e,n){var r,o;if(n===google.maps.GeocoderStatus.OK){if(r=3,o=new google.maps.LatLngBounds,$.each(e,function(e,n){var a;if(!(e>=r))return o.extend(n.geometry.location),a=new google.maps.Marker({map:t.map,position:n.geometry.location,icon:ICON_SEARCH}),google.maps.event.addListener(a,"click",function(e){return this.setMap(null),t.gmapAddMarker(e)}),t.search_markers=initIfNotSet(t.search_markers),t.search_markers.push(a)}),!(e.length>0))return $("#map-search").addClass("has-error").focus();if(t.gmap.fitBounds(o),t.gmap.panToBounds(o),1===e.length)return t.gmap.setZoom(12)}})},t.gmapsSearch=function(e){if(13===e.keyCode||"click"===e.type)return""===$("#map-search").val()?$("#map-search").addClass("has-error").focus():$("#map-search").removeClass("has-error"),t.searchMap($("#map-search").val())},t.loadMarkers=function(){return e.dataLoaded.promise.then(function(){var e;return e=[],$.each(t.tutor.markers,function(n,r){var o;return o=newMarker(t.marker_id++,new google.maps.LatLng(r.lat,r.lng),t.map,r.type,r.id),o.metros=r.metros,o.comment=r.comment,o.setMap(t.map),t.bindMarkerDelete(o),t.bindMarkerChangeType(o),e.push(o)}),t.tutor.markers=_.sortBy(e,function(t){return t.server_id}),n(function(){return t.fully_loaded=!0})})},t.saveMarkers=function(){t.form_changed=!0,$("#gmap-modal").modal("hide"),y()}})}.call(this),function(){angular.module("Egerep").directive("comments",function(){return{restrict:"E",templateUrl:"directives/comments",scope:{user:"=",entityId:"=",trackLoading:"=",entityType:"@"},controller:function(t,e,n,r,o){var a;return e.UserService=o,e.show_max=4,e.show_all_comments=!1,e.showAllComments=function(){return e.show_all_comments=!0,a()},e.getComments=function(){return e.show_all_comments||e.comments.length<=e.show_max?e.comments:_.last(e.comments,e.show_max-1)},e.$watch("entityId",function(n,o){return e.comments=r.query({entity_type:e.entityType,entity_id:n},function(){if(e.trackLoading)return t.loaded_comments++})}),e.formatDateTime=function(t){return moment(t).format("DD.MM.YY в HH:mm")},e.startCommenting=function(t){return e.start_commenting=!0,n(function(){return $(t.target).parent().find("input").focus()})},e.endCommenting=function(){return e.comment="",e.start_commenting=!1},e.remove=function(t){return _.find(e.comments,{id:t}).$remove(),e.comments=_.without(e.comments,_.findWhere(e.comments,{id:t}))},e.edit=function(t,r){var o,a;a=t.comment,o=$(r.target),t.is_being_edited=!0,o.unbind("keydown").unbind("blur"),o.attr("contenteditable","true").focus().on("keydown",function(e){if(console.log(a),13===e.keyCode&&($(this).removeAttr("contenteditable").blur(),$(this).text().length?(t.comment=$(this).text(),t.$update()):$(this).text(t.comment)),27===e.keyCode)return $(this).blur()}).on("blur",function(r){if(n(function(){var n;return null!=(n=_.find(e.comments,{id:t.id}))&&(n.is_being_edited=!1),e.$apply()},200),o.attr("contenteditable"))return console.log(a),o.removeAttr("contenteditable").html(a)})},e.submitComment=function(t){var n;if(13===t.keyCode&&(e.comment.length&&(n=new r({comment:e.comment,user_id:e.user.id,entity_id:e.entityId,entity_type:e.entityType}),n.$save().then(function(t){return console.log(t),n.user=e.user,n.id=t.id,e.comments.push(n)})),e.endCommenting(),a()),27===t.keyCode)return $(t.target).blur()},a=function(){$(".modal:visible").length&&$(".modal:visible").focus()}}}})}.call(this),function(){angular.module("Egerep").directive("editable",function(){return{restrict:"A",link:function(t,e,n){return e.on("click",function(t){return e.attr("contenteditable","true").focus()}).on("keydown",function(t){var n;if(13!==(n=t.keyCode)&&27!==n||(t.preventDefault(),e.blur()),e.data("input-digits-only")&&!(t.keyCode<57))return t.preventDefault()}).on("blur",function(n){return t.onEdit(e.attr("editable"),n),e.removeAttr("contenteditable")})}}})}.call(this),function(){angular.module("Egerep").directive("email",function(){return{restrict:"E",templateUrl:"directives/email",scope:{entity:"="},controller:function(t){return t.send=function(){return $("#email-modal").modal("show")}}}})}.call(this),function(){angular.module("Egerep").directive("ngHighlight",function(){return{restrict:"A",scope:{ngModel:"="},controller:function(t,e,n,r){var o,a;return"INPUT"===$(e).prop("tagName")&&($(e).on("keyup",function(){return o(this)}),r(function(){return o(e)},500)),"SELECT"===$(e).prop("tagName")&&($(e).on("change",function(){return a(this)}),r(function(){return a(e)},500)),o=function(t){return $(t).val()?$(t).parent().find("input, span").addClass("is-selected"):$(t).parent().find("input, span").removeClass("is-selected")},a=function(t){return $(t).parent().find("button").removeClass("is-selected"),$(t).parent().find('select > option[value!=""]:selected').parent("select").siblings("button").addClass("is-selected")}}}})}.call(this),function(){angular.module("Egerep").directive("inputComment",function(){return{restrict:"E",templateUrl:"directives/input-comment",scope:{entity:"=",commentField:"@"},controller:function(t,e){return t.is_being_commented=!1,t.blurComment=function(){return t.is_being_commented=!1},t.focusComment=function(){return t.is_being_commented=!0},t.startComment=function(n){return t.is_being_commented=!0,e(function(){return $(n.target).parent().children("input").focus()})},t.endComment=function(t){13===t.keyCode&&$(t.target).blur()}}}})}.call(this),function(){angular.module("Egerep").directive("metroListFull",function(){return{restrict:"E",templateUrl:"directives/metro-list-full",scope:{markers:"="},controller:function(t,e,n){return t.minutes=function(t){return Math.round(t)}}}})}.call(this),function(){angular.module("Egerep").directive("metroList",function(){return{restrict:"E",templateUrl:"directives/metro-list",scope:{markers:"="},controller:function(t,e,n){return t.inline=n.hasOwnProperty("inline"),t.one_station=n.hasOwnProperty("oneStation"),t["short"]=function(t){return t.slice(0,3).toUpperCase()},t.minutes=function(t){return Math.round(t)},t.editMarkerModal=function(e){return $("#marker-modal").modal("show"),t.selected_marker=e,t.marker_comment=e.comment},t.editMarker=function(){return $("#marker-modal").modal("hide"),t.$parent.form_changed=!0,t.selected_marker.comment=t.marker_comment}}}})}.call(this),function(){angular.module("Egerep").directive("ngMulti",function(){return{restrict:"E",replace:!0,scope:{object:"=",model:"=",noneText:"@"},templateUrl:"directives/ngmulti",controller:function(t,e,n,r){if(t.highlight=n.hasOwnProperty("highlight"),r(function(){return $(e).selectpicker({noneSelectedText:t.noneText})}),t.highlight)return t.$watch("model",function(t,n){if(t)return r(function(){return $(e).parent().find("button").removeClass("is-selected"),$(e).parent().find('select > option[value!=""]:selected').parent("select").siblings("button").addClass("is-selected")})})}}})}.call(this),function(){angular.module("Egerep").directive("ngSelectNew",function(){return{restrict:"E",replace:!0,scope:{object:"=",model:"=",noneText:"@",label:"@",field:"@"},templateUrl:"directives/select-new",controller:function(t,e,n,r){var o;return t.noneText||(o=_.first(Object.keys(t.object)),t.field&&(o=t.object[o][t.field]),t.model||(t.model=o)),r(function(){return e.selectpicker({noneSelectedText:t.noneText})},100),t.$watchGroup(["model","object"],function(t){if(t)return r(function(){return e.selectpicker("refresh")})})}}})}.call(this),function(){angular.module("Egerep").directive("notifications",function(){return{restrict:"E",templateUrl:"directives/notifications",scope:{user:"=",entityId:"=",trackLoading:"=",entityType:"@"},controller:function(t,e,n,r,o){var a,i,u,s;return e.show_max=4,e.show_all_notifications=!1,e.Notification=r,e.Notify=o,a=function(t){return $("#notification-"+t).find(".notification-date-add").mask("d9.y9.y9",{clearIfNotMatch:!0})},n(function(){return e.notifications.forEach(function(t){return a(t.id)})},2e3),e.showAllNotifications=function(){return e.show_all_notifications=!0,n(function(){return e.notifications.forEach(function(t){return a(t.id)})})},e.getNotifications=function(){return e.show_all_notifications||e.notifications.length<=e.show_max?e.notifications:_.last(e.notifications,e.show_max-1)},e.hack=function(t,n){e.setEditing(t),$(n.target).attr("contenteditable",!0).focus()},e.setEditing=function(t){return n(function(){return t.is_being_edited=!0},200)},e.unsetEditing=function(t){return n(function(){var n;return null!=(n=_.find(e.notifications,{id:t.id}))?n.is_being_edited=!1:void 0},150)},e.toggle=function(e){return t.toggleEnumServer(e,"approved",o,r)},e.$watch("entityId",function(t,o){return e.notifications=r.query({entity_type:e.entityType,entity_id:t},function(){return n(function(){return e.$apply()})})}),e.formatDateTime=function(t){return moment(t).format("DD.MM.YY в HH:mm")},e.startNotificationing=function(t){return e.start_notificationing=!0,n(function(){return $(t.target).parents("div").first().find("div").focus(),$(t.target).parents("div").first().find("input").mask("d9.y9.y9",{clearIfNotMatch:!0})})},e.endNotificationing=function(t,n){return t.html(""),n.val(""),e.start_notificationing=!1},e.remove=function(t){return _.find(e.notifications,{id:t}).$remove(),e.notifications=_.without(e.notifications,_.findWhere(e.notifications,{id:t}))},s=function(t,e){var n,o,a,i,u;return e.preventDefault(),u=$(e.target).parents("div").first(),o=u.find("div").last(),i=u.find("input"),n=o.text(),a=i.val(),""===a||a.match(/_/)?(console.log("no date",a,i),void i.blur().focus()):""===n?(console.log("no comment",n,o),void o.focus()):r.update({id:t.id},{comment:n,date:a},function(){return t.comment=n,t.date=a})},e.editNotification=function(t,e){i(e),13===e.keyCode&&(e.preventDefault(),$(e.target).blur(),window.getSelection().removeAllRanges(),s(t,e)),27===e.keyCode&&(window.getSelection().removeAllRanges(),$(e.target).blur().html(t.comment),$(e.target).is("input")&&$(e.target).siblings("div.new-notification").html(t.comment),$(e.target).is("div.new-notification")&&$(e.target).siblings("input").val(t.date))},u=function(t){var o,i,u,s,c,d;return d=$(t.target).parents("div").first(),i=d.find("div").last(),s=d.find("input"),o=i.text(),u=s.val(),""===u||u.match(/_/)?void s.blur().focus():""===o?void i.focus():(c=new r({comment:o,user_id:e.user.id,entity_id:e.entityId,date:u,entity_type:e.entityType}),c.$save().then(function(t){return console.log(t),c.user=e.user,c.id=t.id,c.approved=0,
e.notifications.push(c),n(function(){return a(c.id)})}),e.endNotificationing(i,s))},i=function(e){var n,r,o,a,i;if("DIV"!==$(e.target).prop("tagName"))return 38===(i=e.keyCode)||40===i?(e.preventDefault(),o=$(e.target).parents("div").first().find("input"),r=o.val(),r.match(/_/)?o.val(t.formatDate(moment())):(n=38===e.keyCode?1:-1,a=t.formatDate(moment("20"+convertDate(r)).add({day:n})),o.val(a))):void 0},e.submitNotification=function(t){i(t),13===t.keyCode&&(t.preventDefault(),u(t)),27===t.keyCode&&(window.getSelection().removeAllRanges(),$(t.target).blur(),e.start_notificationing=!1)},e.defaultNotification=function(){var t;return t=new r({comment:"стандартное напоминание",user_id:e.user.id,entity_id:e.entityId,entity_type:e.entityType,approved:1,date:moment(convertDate(e.$parent.selected_attachment.date)).add(2,"days").format("DD.MM.YY")}),t.$save().then(function(r){return t.user=e.user,t.id=r.id,t.approved=1,e.notifications.push(t),n(function(){return a(t.id)})})}}}})}.call(this),function(){angular.module("Egerep").directive("pencilInput",function(){return{restrict:"E",replace:!0,templateUrl:"directives/pencil-input",scope:{model:"="},controller:function(t,e,n,r){return t.is_being_commented=!1,t.blurComment=function(){return t.is_being_commented=!1},t.focusComment=function(){return t.is_being_commented=!0},t.startComment=function(n){return t.is_being_commented=!0,e(function(){return $(n.target).parent().children("div").focus()})},t.watchEnter=function(e){var n;13!==(n=e.keyCode)&&27!==n||(13===e.keyCode&&(t.model=$(e.target).parent().children("div").text()),$(e.target).parent().children("div").text(t.model),e.preventDefault(),$(e.target).blur())}}}})}.call(this),function(){angular.module("Egerep").directive("phone",function(){return{restrict:"E",templateUrl:"directives/phone",controller:function(t,e,n,r){return t.PhoneService=r,t.phone="",t.phoneMaskControl=function(e){return t.phone=$(e.target).val()},t.isFull=function(t){return void 0!==t&&""!==t&&!t.match(/_/)},t.ssms=function(t){return $("#sms-modal").modal("show"),n.sms_number=t}}}})}.call(this),function(){angular.module("Egerep").directive("phones",function(){return{restrict:"E",templateUrl:"directives/phones",scope:{entity:"="},controller:function(t,e,n,r,o,a){var i;return t.PhoneService=r,t.UserService=o,t.is_playing_stage="stop",t.isOpened=!1,n.dataLoaded.promise.then(function(e){return t.level=t.entity.phones&&t.entity.phones.length?t.entity.phones.length:1}),t.nextLevel=function(){return t.level++},t.phoneMaskControl=function(e){var n,r;return n=$(e.target),r=n.attr("ng-model").split(".")[1],t.entity[r]=$(e.target).val()},t.isFull=function(t){return void 0!==t&&""!==t&&!t.match(/_/)},t.sms=function(t){return $("#sms-modal").modal("show"),n.sms_number=t},t.info=function(e){return t.api_number=e,t.mango_info=null,$("#api-phone-info").modal("show"),t.isOpened===!1&&$("#api-phone-info").on("hidden.bs.modal",function(){if(t.isOpened=!0,t.audio)return t.audio.pause(),t.audio=null,t.is_playing_stage="stop",t.is_playing=null}),r.info(e).then(function(e){return t.mango_info=e.data})},t.formatDateTime=function(t){return moment(t).format("DD.MM.YY в HH:mm")},t.time=function(t){return moment(0).seconds(t).format("mm:ss")},t.getNumberTitle=function(e){return e===r.clean(t.api_number)?"текущий номер":e},i=function(t){var e,n,r,o,a;return e="goea67jyo7i63nf4xdtjn59npnfcee5l",n="t9mp7vdltmhn0nhnq0x4vwha9ncdr8pa",a=moment().add(5,"minute").unix(),r=new jsSHA("SHA-256","TEXT"),r.update(e+a+t+n),o=r.getHash("HEX"),"https://app.mango-office.ru/vpbx/queries/recording/link/"+t+"/play/"+e+"/"+a+"/"+o},t.intervalStart=function(){return t.interval=a(function(){if(t.audio&&(t.current_time=angular.copy(t.audio.currentTime),t.prc=(100*t.current_time/t.audio.duration).toFixed(2),100===parseInt(t.prc)))return t.stop()},10)},t.intervalCancel=function(){return a.cancel(t.interval)},t.initAudio=function(e){return t.is_playing&&t.stop(),t.audio=new Audio(i(e)),t.current_time=0,t.prc=0,t.is_playing_stage="start",t.is_playing=e},t.pause=function(){return t.intervalCancel(),t.audio&&t.audio.pause(),t.is_playing_stage="pause"},t.play=function(e){return t.isPlaying(e)||t.initAudio(e),"play"===t.is_playing_stage?t.pause():(t.audio.play(),t.is_playing_stage="play",t.intervalStart())},t.isPlaying=function(e){return t.is_playing===e},t.stop=function(){return t.prc=0,t.is_playing=null,t.audio.pause(),t.audio=null,t.is_playing_stage="stop",t.intervalCancel()},t.setCurentTime=function(e){var n,r;return r=angular.element(e.target).width(),t.prc=100*e.offsetX/r,n=t.audio.duration*t.prc/100,t.audio.currentTime=n}}}})}.call(this),function(){angular.module("Egerep").directive("plural",function(){return{restrict:"E",scope:{count:"=",type:"@",noneText:"@",additional:"="},templateUrl:"directives/plural",controller:function(t,e,n,r){return t.textOnly=n.hasOwnProperty("textOnly"),t.hideZero=n.hasOwnProperty("hideZero"),t.when={age:["год","года","лет"],student:["ученик","ученика","учеников"],minute:["минуту","минуты","минут"],hour:["час","часа","часов"],day:["день","дня","дней"],meeting:["встреча","встречи","встреч"],score:["балл","балла","баллов"],rubbles:["рубль","рубля","рублей"],lesson:["занятие","занятия","занятий"],client:["клиент","клиента","клиентов"],mark:["оценки","оценок","оценок"],request:["заявка","заявки","заявок"]}}}})}.call(this),function(){angular.module("Egerep").directive("plus",function(){return{restrict:"E",scope:{previous:"=",count:"="},templateUrl:"directives/plus"}})}.call(this),function(){angular.module("Egerep").directive("publishedField",function(){return{restrict:"E",replace:!0,templateUrl:"directives/published-field",scope:{inEgeCentr:"@"}}})}.call(this),function(){angular.module("Egerep").directive("ngSelect",function(){return{restrict:"E",replace:!0,scope:{object:"=",model:"=",noneText:"@"},templateUrl:"directives/ngselect",controller:function(t,e,n){if(!t.noneText)return t.model=_.first(Object.keys(t.object))}}})}.call(this),function(){angular.module("Egerep").directive("sms",function(){return{restrict:"E",templateUrl:"directives/sms",scope:{number:"="},controller:function(t,e,n,r){var o;return r.bind("SmsStatusUpdate",function(e){return angular.forEach(t.history,function(n,r){return n.external_id===e.external_id&&(n.id_status=e.id_status,t.$apply()),console.log(n,r)})}),t.smsCount=function(){return SmsCounter.count(t.message||"").messages},t.send=function(){var e;if(t.message)return t.sms_sending=!0,ajaxStart(),e=new n({message:t.message,to:t.number}),e.$save().then(function(e){return ajaxEnd(),t.sms_sending=!1,t.message="",t.history.push(e),o()})},t.$watch("number",function(e,r){return console.log(t.$parent.formatDateTime(t.created_at)),e&&(t.history=n.query({number:e})),o()}),o=function(){return e(function(){return $("#sms-history").animate({scrollTop:$(window).height()},"fast")})}}}})}.call(this),function(){angular.module("Egerep").directive("tutorPhoto",function(){return{restrict:"E",replace:!0,scope:{tutor:"=",version:"="},templateUrl:"directives/tutor-photo"}})}.call(this),function(){angular.module("Egerep").directive("userSwitch",function(){return{restrict:"E",scope:{entity:"=",resource:"=",userId:"@"},templateUrl:"directives/user-switch",controller:function(t){return t.UserService=t.$parent.UserService}}})}.call(this),function(){angular.module("Egerep").directive("user",function(){return{restrict:"E",scope:{model:"="},templateUrl:"directives/user"}})}.call(this),function(){angular.module("Egerep").value("Approved",{0:"не подтвержден",1:"подтвержден"}).value("Confirmed",{0:"подтвердить",1:"подтверждено"}).value("Months",{1:"январь",2:"февраль",3:"март",4:"апрель",5:"май",6:"июнь",7:"июль",8:"август",9:"сентябрь",10:"октябрь",11:"ноябрь",12:"декабрь"}).value("Years",{2017:"2017–2018 уч. г.",2018:"2018–2019 уч. г."}).value("Notify",["напомнить","не напоминать"]).value("AttachmentErrors",{1:"в стыковке не указан класс",2:"в стыковке не указан хотя бы 1 предмет",3:"в стыковке поле условия пусто",4:"стыковка скрыта и занятий к проводке > 0",5:"стыковка скрыта и архивация отсутствует",6:"есть занятия до даты стыковки",7:"есть занятия после даты архивации",8:"есть занятия после последнего расчета",9:"дата архивации раньше даты стыковки",10:"поле детали архивации пусто",11:"если занятий не было, измените дату архивации (через 7 дней после даты стыковки)",12:"если занятий не было, скройте стыковку",13:"занятия и прогноз не сочетаются",14:"занятия и прогноз не сочетаются",15:"если занятия к проводке не установлены, дата архивации должна совпадать с датой последнего занятия",16:"если занятия к проводке не установлены, скройте стыковку",17:"класс клиента  и статус разархивации не сочетаются",18:"некорректный прогноз",19:"некорректное количество занятий к проводке",20:"некорректная сумма за занятие в отчетности",21:"некорректная комиссия за занятие в отчетности"}).value("ReviewErrors",{1:"отзыв опубликован + нет отзыва",2:"отзыв опубликован + нет подписи",3:"отзыв опубликован + оценка НЕ = от 1 до 10",4:"оценка с 1 по 10 + текст отзыва пусто",5:"текст отзыва НЕ пусто + оценка пусто",6:"оценка = от 6 до 10 + отзыв не опубликован"}).value("TutorErrors",{1:"в анкете нет ни одного телефона",2:"дублирование телефонного номера в нескольких анкетах",3:"статус репетитора: опубликован, к одобрению, одобрено, однако не заполнено одно из полей, использующееся на сайте",4:"статус репетитора опубликован + у репетитора отустствует фото"}).value("UnderModer",{0:"на рассмотрении",1:"одобрено",2:"отказано"}).value("RequestErrors",{1:"статус заявки выполнено + в заявке нет ни одной стыковки",2:"статус заявки отказ + в заявке есть стыковки",3:"статус заявки отказ + ответственный не установлен"}).value("AccountErrors",{1:"в расчете отсутствуют платежи (в том числе взаимозачеты)",2:"в расчете не проведено ни одного занятия"}).value("LogTypes",{create:"создание",update:"обновление","delete":"удаление",authorization:"авторизация",url:"просмотр URL"}).value("Recommendations",{1:{text:"У этого репетитора уже было несколько расчетов, поэтому ему можно доверить длительное обучение, требующееся данному клиенту",type:0},2:{text:"У этого репетитора был всего 1 расчет и ему можно доверить длительное обучение, но лучше поискать более проверенные варианты",type:1},3:{text:"С этим репетитором не было встреч и есть клиенты, за которых он еще не рассчитался. Отдавать этого клиента категорически нельзя",type:2},4:{text:"С этим репетитором не было встреч и у него нет активных клиентов. Отдавать ему клиента можно, но только в крайнем случае",type:1},5:{text:"У этого репетитора уже было несколько расчетов, поэтому ему можно доверить данного клиента",type:0},6:{text:"У этого репетитора был всего 1 расчет, то есть у него средний кредитный рейтинг. Если более проверенных репетиторов нет, ему можно доверить этого клиента",type:1},7:{text:"С этим репетитором не было встреч и есть клиенты, за которых он еще не рассчитался. Отдавать этого репетитора можно в самом крайнем случае",type:2},8:{text:"С этим репетитором не было встреч и у него нет активных клиентов. Риск сотрудничества средний, поэтому работать с репетитором можно, если нет других вариантов",type:1},9:{text:"У этого репетитора высокий кредитный рейтинг, но конец учебного года лучше использовать для проверки неизвестных репетиторов",type:1},10:{text:"Этому репетитору мы не доверяем, но сейчас отличное время для его проверки. Если сотрудничество будет успешным, то мы будем рекомендовать в следующем году как проверенного. Если он не заплатит, то невыплаты будут минимальными и репетитора мы закроем навсегда, в чем великая польза.",type:0},11:{text:"С 10-классниками нужно быть особенно аккуратными и этот репетитор в данном случае рекомендован",type:0},12:{text:"С этим репетитором была всего 1 встреча, поэтому давать его ученику 10 класса будет риском. Сделайте все, чтобы избежать этого, но если не получается – давать можно",type:1},13:{text:"С этим репетитором не было встреч и есть клиенты, за которых он еще не рассчитался. Нужно сделать все, чтобы 10-классник его не получил, так как 10 классы всегда продолжают заниматься и в 11 классе. Давать этого репетитора категорически нельзя",type:2},14:{text:"Этот репетитор для компании новый. Давать 10-класснику можно, но в самом крайнем случае",type:2}}).value("RecommendationTypes",["очень рекомендован","средне рекомендован","не рекомендован"]).value("DebtTypes",{0:"не доплатил",1:"переплатил"}).value("Weekdays",{0:"пн",1:"вт",2:"ср",3:"чт",4:"пт",5:"сб",6:"вс"}).value("Destinations",{r_k:"репетитор едет к клиенту",k_r:"клиент едет к репетитору"}).value("Workplaces",{0:"не активен в системе",1:"преподаватели запаса",2:"ведут занятия сейчас",3:"ранее работал"}).value("Genders",{male:"мужской",female:"женский"}).value("YesNo",{0:"нет",1:"да"}).value("TutorPublishedStates",{0:"не опубликован",1:"опубликован"}).value("PaymentMethods",{0:"стандартный расчет",1:"яндекс.деньги",2:"перевод на карту"}).value("ArchiveStates",{impossible:"невозможно",possible:"возможно"}).value("ReviewStates",{unpublished:"не опубликован",published:"опубликован"}).value("Existance",["созданные","требующие создания"]).value("Presence",[["есть","отсутствует"],["есть","нет"]]).value("AttachmentVisibility",{0:"показано",1:"скрыто"}).value("AttachmentStates",{"new":"новые",inprogress:"рабочие",ended:"завершенные"}).value("AttachmentState",{"new":"новый",inprogress:"рабочий",ended:"завершенный"}).value("Checked",["не проверено","проверено"]).value("ReviewScores",{1:1,2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,10:10,11:"отзыв не собирать",12:"отзыв собрать позже"}).value("Grades",{1:"1 класс",2:"2 класс",3:"3 класс",4:"4 класс",5:"5 класс",6:"6 класс",7:"7 класс",8:"8 класс",9:"9 класс",10:"10 класс",11:"11 класс",12:"студенты вуза",14:"студенты колледжа",13:"остальные"}).value("CallStatuses",{1:"входящие без ответа",2:"соответствие договорам",3:"нет повторов в рамках 2 недель",4:"преподаватель"}).value("Subjects",{all:{1:"математика",2:"физика",3:"химия",4:"биология",5:"информатика",6:"русский",7:"литература",8:"обществознание",9:"история",10:"английский",11:"география"},full:{1:"Математика",2:"Физика",3:"Химия",4:"Биология",5:"Информатика",6:"Русский язык",7:"Литература",8:"Обществознание",9:"История",10:"Английский язык",11:"География"},dative:{1:"математике",2:"физике",3:"химии",4:"биологии",5:"информатике",6:"русскому языку",7:"литературе",8:"обществознанию",9:"истории",10:"английскому языку",11:"географии"},"short":["М","Ф","Р","Л","А","Ис","О","Х","Б","Ин","Г"],three_letters:{1:"МАТ",2:"ФИЗ",3:"ХИМ",4:"БИО",5:"ИНФ",6:"РУС",7:"ЛИТ",8:"ОБЩ",9:"ИСТ",10:"АНГ",11:"ГЕО"},short_eng:["math","phys","rus","lit","eng","his","soc","chem","bio","inf","geo"]})}.call(this),function(){var t,e;angular.module("Egerep").factory("Marker",function(n){return n(t("markers"),{id:"@id"},e())}).factory("Notification",function(n){return n(t("notifications"),{id:"@id"},e())}).factory("Account",function(n){return n(t("accounts"),{id:"@id"},e())}).factory("AccountPayment",function(n){return n(t("account/payments"),{id:"@id"},e())}).factory("PlannedAccount",function(n){return n(t("periods/planned"),{id:"@id"},e())}).factory("Review",function(n){return n(t("reviews"),{id:"@id"},e())}).factory("Background",function(n){return n(t("background"),{id:"@id"},e())}).factory("Archive",function(n){return n(t("archives"),{id:"@id"},e())}).factory("Attachment",function(n){return n(t("attachments"),{id:"@id"},e())}).factory("RequestList",function(n){return n(t("lists"),{id:"@id"},e())}).factory("Request",function(e){return e(t("requests"),{id:"@id"},{update:{method:"PUT"},transfer:{method:"POST",url:t("requests","transfer")},list:{method:"GET"}})}).factory("Sms",function(n){return n(t("sms"),{id:"@id"},e())}).factory("Payment",function(n){return n(t("payments"),{id:"@id"},e())}).factory("PaymentSource",function(n){return n(t("payments/sources"),{id:"@id"},e())}).factory("SourceRemainder",function(n){return n(t("payments/source/remainders"),{id:"@id"},e())}).factory("PaymentExpenditure",function(n){return n(t("payments/expenditures"),{id:"@id"},e())}).factory("PaymentExpenditureGroup",function(n){return n(t("payments/expendituregroups"),{id:"@id"},e())}).factory("Comment",function(n){return n(t("comments"),{id:"@id"},e())}).factory("Client",function(n){return n(t("clients"),{id:"@id"},e())}).factory("User",function(n){return n(t("users"),{id:"@id"},e())}).factory("Tutor",function(e){return e(t("tutors"),{id:"@id"},{update:{method:"PUT"},deletePhoto:{url:t("tutors","photo"),method:"DELETE"},list:{method:"GET"}})}),t=function(t,e){return null==e&&(e=""),"api/"+t+"/"+(e?e+"/":"")+":id"},e=function(){return{update:{method:"PUT"}}}}.call(this),function(){angular.module("Egerep").service("ApiService",function(t){return this.metro=function(e,n){return t.post("api/metro/"+e,n)},this})}.call(this),function(){angular.module("Egerep").service("AttachmentService",function(t){return this.AttachmentStates=t,this.getState=function(t){return t.archive?"ended":t.forecast?"inprogress":"new"},this.getStatus=function(t){return this.AttachmentStates[this.getState(t)]},this})}.call(this),function(){angular.module("Egerep").service("BranchService",function(t){return this.branches=t,this.getNameWithColor=function(t){var e;return e=this.branches[t],'<svg xmlns="http://www.w3.org/2000/svg" version="1.1" class="svg-metro"><circle fill="'+e.color+'" r="6" cx="7" cy="7"></circle></svg>'+e.full},this})}.call(this),function(){angular.module("Egerep").service("IndexService",function(t){return this.filter=function(){return $.cookie(this.controller,JSON.stringify(this.search),{expires:365,path:"/"}),this.current_page=1,this.pageChanged()},this.max_size=10,this.init=function(e,n,r,o){if(null==o&&(o=!0),t.frontend_loading=!0,this.Resource=e,this.current_page=parseInt(n),this.controller=r.ngController.toLowerCase().slice(0,-5),this.search=$.cookie(this.controller)?JSON.parse($.cookie(this.controller)):{},o)return this.loadPage()},this.loadPage=function(){var e;return e={page:this.current_page},void 0!==this.sort&&(e.sort=this.sort),this.Resource.get(e,function(e){return function(n){return e.page=n,e.data_loaded=!0,t.frontend_loading=!1}}(this))},this.pageChanged=function(){return t.frontend_loading=!0,this.loadPage(),this.changeUrl()},this["delete"]=function(t,e){return bootbox.confirm("Вы уверены, что хотите удалить "+e+" #"+t+"?",function(e){return function(n){if(n===!0)return e.Resource["delete"]({id:t},function(){return location.reload()})}}(this))},this.changeUrl=function(){return window.history.pushState("","",this.controller+"?page="+this.current_page)},this}).service("FormService",function(t,e,n){var r,o,a;return this.init=function(n,r,a){return this.dataLoaded=e.defer(),t.frontend_loading=!0,this.Resource=n,this.saving=!1,r?this.model=n.get({id:r},function(t){return function(){return o()}}(this)):(this.model=new n(a),o())},o=function(e){return function(){return t.frontend_loading=!1,n(function(){return e.dataLoaded.resolve(!0),$(".selectpicker").selectpicker("refresh")})}}(this),r=function(t){return function(){return void 0===t.error_element?(ajaxStart(),void 0!==t.beforeSave&&t.beforeSave(),t.saving=!0,!0):($(t.error_element).focus(),!1)}}(this),a=function(){var t,e;return t=window.location.pathname.split("/"),e=t[t.length-2],$.isNumeric(e)&&(e=t[t.length-3]),e},this["delete"]=function(t,e){return null==e&&(e=!1),bootbox.confirm("Вы уверены, что хотите "+$(t.target).text()+" #"+this.model.id+"?",function(t){return function(n){if(n===!0)return r(),t.model.$delete().then(function(){return e?(e(),t.saving=!1,ajaxEnd()):redirect(a())},function(t){return notifyError(t.data.message)})}}(this))},this.edit=function(t){if(null==t&&(t=null),r())return this.model.$update().then(function(e){return function(){return null!==t&&t(),e.saving=!1,ajaxEnd()}}(this),function(t){return notifyError(t.data.message),this.saving=!1,ajaxEnd()})},this.create=function(){if(r())return this.model.$save().then(function(t){return function(e){return redirect(t.prefix+a()+("/"+e.id+"/edit"))}}(this),function(t){return function(e){return notifyError(e.data.message),t.saving=!1,ajaxEnd(),t.onCreateError(e)}}(this))},this})}.call(this),function(){angular.module("Egerep").service("PhoneService",function(t,e){return this.info=function(t){return e.post("api/command/mango-stats",{number:t})},this.call=function(t){return location.href="tel:"+t.replace(/[^0-9]/g,"")},this.isMobile=function(t){return t&&(9===parseInt(t[4])||9===parseInt(t[1]))},this.clean=function(t){return t.replace(/[^0-9]/gim,"")},this.format=function(t){if(t)return t=this.clean(t),"+"+t.substr(0,1)+" ("+t.substr(1,3)+") "+t.substr(4,3)+"-"+t.substr(7,2)+"-"+t.substr(9,2)},this.sms=function(e){return t.sms_number=e,$("#sms-modal").modal("show")},this})}.call(this),function(){angular.module("Egerep").service("PusherService",function(t){var e;return this.bind=function(t,n){return void 0===this.pusher&&e(),this.channel.bind("App\\Events\\"+t,n)},e=function(t){return function(){return t.pusher=new Pusher("2d212b249c84f8c7ba5c",{encrypted:!0,cluster:"eu"}),t.channel=t.pusher.subscribe("egerep")}}(this),this})}.call(this),function(){angular.module("Egerep").service("RecommendationService",function(t,e){return this.get=function(t,n){var r;return r=this.getRecommendation(t,n),r.type_text=e[r.type],r},this.getRecommendation=function(e,n){var r;return r=moment().format("M"),10!==n?r>=7&&r<=10?e.meeting_count>=2?t[1]:1===e.meeting_count?t[2]:e.active_clients_count>=2?t[3]:t[4]:r>=11||r<=2?e.meeting_count>=2?t[5]:1===e.meeting_count?t[6]:e.active_clients_count>=2?t[7]:t[8]:e.meeting_count>=2?t[9]:t[10]:e.meeting_count>=2?t[11]:1===e.meeting_count?t[12]:e.active_clients_count>=2?t[13]:t[14]},this})}.call(this),function(){angular.module("Egerep").service("SvgMap",function(){return this.show=function(){$("#svg-modal").modal("show")},this})}.call(this),function(){angular.module("Egerep").service("TutorService",function(t){return this.translit={"А":"A","Б":"B","В":"V","Г":"G","Д":"D","Е":"E","Ё":"E","Ж":"Gh","З":"Z","И":"I","Й":"Y","К":"K","Л":"L","М":"M","Н":"N","О":"O","П":"P","Р":"R","С":"S","Т":"T","У":"U","Ф":"F","Х":"H","Ц":"C","Ч":"Ch","Ш":"Sh","Щ":"Sch","Ъ":"Y","Ы":"Y","Ь":"Y","Э":"E","Ю":"Yu","Я":"Ya","а":"a","б":"b","в":"v","г":"g","д":"d","е":"e","ё":"e","ж":"gh","з":"z","и":"i","й":"y","к":"k","л":"l","м":"m","н":"n","о":"o","п":"p","р":"r","с":"s","т":"t","у":"u","ф":"f","х":"h","ц":"c","ч":"ch","ш":"sh","щ":"sch","ъ":"y","ы":"y","ь":"y","э":"e","ю":"yu","я":"ya"},this.default_tutor={gender:"male",branches:[],phones:[],subjects:[],grades:[],svg_map:[],markers:[],state:0,in_egecentr:0},this.getFiltered=function(e){return t.post("api/tutors/filtered",e)},this.select=function(e){return t.post("api/tutors/select",e)},this.getDebtMap=function(e){return t.post("api/debt/map",e)},this.getDebtors=function(){return t.get("api/debt")},this.generateLogin=function(t){var e,n,r,o,a;for(o="",a=t.last_name.toLowerCase(),e=0,n=a.length;e<n;e++)r=a[e],o+=this.translit[r];return o=o.slice(0,3),o+="_"+this.translit[t.first_name.toLowerCase()[0]]+this.translit[t.middle_name.toLowerCase()[0]]},this.generatePassword=function(){return Math.floor(1e7+89999999*Math.random())},this})}.call(this),function(){angular.module("Egerep").service("UserService",function(t,e,n){var r;return this.users=t.query(),n(function(t){return function(){return t.current_user=e.$$childTail.user}}(this)),r={color:"#999999",login:"system",id:0},this.get=function(t){return this.getUser(t)},this.getUser=function(t){return _.findWhere(this.users,{id:parseInt(t)})||r},this.getLogin=function(t){return this.getUser(parseInt(t)).login},this.getColor=function(t){return this.getUser(parseInt(t)).color},this.getWithSystem=function(t){var e;return null==t&&(t=!0),e=this.getAll(t),e.unshift(r),e},this.getAll=function(t){return null==t&&(t=!0),t?_.filter(this.users,function(t){return t.rights.length&&t.rights.indexOf("35")===-1}):this.users},this.toggle=function(t,e,n){var r,o;return null==n&&(n=!1),r=t[e]?0:this.current_user.id,n?n.update((o={id:t.id},o[""+e]=r,o),function(){return t[e]=r}):t[e]=r},this.getBannedUsers=function(){return _.filter(this.users,function(t){return t.rights.length&&t.rights.indexOf("35")!==-1})},this.getBannedHaving=function(t){return _.filter(this.users,function(e){return e.rights.indexOf("35")!==-1&&t&&t[e.id]})},this.getActiveInAnySystem=function(t){var e;return null==t&&(t=!0),e=_.chain(this.users).filter(function(t){return t.rights.indexOf("35")===-1||t.rights.indexOf("34")===-1}).sortBy("login").value(),t&&e.unshift(r),e},this.getBannedInBothSystems=function(){return _.chain(this.users).filter(function(t){return t.rights.indexOf("35")!==-1&&t.rights.indexOf("34")!==-1}).sortBy("login").value()},this})}.call(this);